@use "sass:map";
@use "sass:meta";
@use "sass:list";
@use "sass:string";
@use "./utils" as utils;

// =============================================================================
// COLORIZATION MIXINS
// Unified surface/contrast color generation
// =============================================================================

// Internal: Apply surface palette to elements
@mixin _apply-palette($selectors, $color: var(--on-surface-color, currentColor), $set-icon: false) {
    #{$selectors} {
        border-color: var(--border-color, transparent);
        background-color: var(--surface-color, transparent);
        color: #{$color};
        accent-color: #{$color};
        caret-color: #{$color};
        text-decoration-color: #{$color};
        text-emphasis-color: #{$color};
        scrollbar-color: var(--scrollbar-color) transparent;
        -webkit-text-fill-color: currentColor;

        @if $set-icon {
            --icon-color: #{$color};
        }
    }
}

// =============================================================================
// SOLID COLORIZE - Main colorization mixin
// =============================================================================

@mixin solid-colorize(
    $selector: "&",
    $options: ()
) {
    // Parse options with defaults
    $base-shade: utils.option-or($options, "shade", 0);
    $base-tint: utils.option-or($options, "tint", 0);
    $scheme-id: utils.option-or($options, "scheme-id", 2);
    $scope: utils.option-or($options, "scope", "component");
    $propagate: utils.option-or($options, "propagate", if($scope == "selector", false, true));
    $forms-background: utils.option-or($options, "forms-background", $propagate);
    $global-targets: utils.option-or($options, "global-targets", $propagate);

    #{$selector} {
        // Core color modifiers
        --color-shade: #{$base-shade};
        --color-tint: #{$base-tint};
        --color-source: var(--current, var(--primary, #469));

        // Computed surface colors (simplified chain)
        --surface-color: --c2-surface(var(--_color-shade, 0), var(--color-source), #{$scheme-id});
        --on-surface-color: --c2-on-surface(var(--_color-tint, 0), var(--color-source), #{$scheme-id});
        --on-surface: var(--on-surface-color);
        --scrollbar-color: oklch(from var(--on-surface-color) l c h / 0.4);
        --border-color: oklch(from --c2-surface(calc(var(--_color-shade, 0) + 0.05), var(--color-source), #{$scheme-id}) l c h / 0.1);

        // Apply palette to self
        @include _apply-palette("&", var(--on-surface-color), true);
        @include _apply-palette("&::picker(select)", var(--on-surface-color));

        // Text elements
        &:where(a, span, ui-icon) {
            @include _apply-palette("&", var(--on-surface-color), true);
            background-color: transparent;
            &::selection {
                color: var(--surface-color);
                background-color: var(--on-surface-color);
                --icon-color: var(--surface-color);
            }
        }

        // Form element base styling
        &:where(button, input, select, textarea) {
            border-style: solid;
            border-width: 0.5px;
        }

        // Propagated selectors
        @if $propagate {
            @include _apply-palette("& :where(select)", var(--on-surface-color));

            :where(a, span, ui-icon) {
                background-color: transparent;
                &::selection { background-color: var(--on-surface-color); }
            }

            @if $global-targets {
                ::picker(select) { background-color: transparent; }
                ui-icon {
                    background-color: transparent;
                    --icon-color: var(--on-surface-color);
                }
            }
        }

        // Interactive form elements
        $interactive-scope: if(
            $propagate,
            "&:where(button, input, select, textarea, option), & :where(button, input, select, textarea, option)",
            "&:where(button, input, select, textarea, option)"
        );

        #{$interactive-scope} {
            @if $propagate {
                @include _apply-palette("&", var(--on-surface-color), true);
            }

            @if $forms-background {
                background-color: color-mix(in oklch, var(--surface-color) 96%, var(--on-surface-color) 10%);
            }

            // State transitions
            transition:
                --_color-shade var(--transition-normal, 160ms ease),
                --surface-color var(--transition-normal, 160ms ease),
                --on-surface-color var(--transition-normal, 160ms ease),
                border-color var(--transition-normal, 160ms ease),
                background-color var(--transition-normal, 160ms ease),
                box-shadow var(--transition-normal, 160ms ease),
                opacity var(--transition-normal, 160ms ease);

            // Default state
            --_color-shade: var(--color-shade, 0);

            // Interactive states
            @include utils.when-hover { --_color-shade: calc(var(--color-shade, 0) + var(--hover-lift, 0.03)); }
            @include utils.when-active { --_color-shade: calc(var(--color-shade, 0) + var(--active-lift, 0.05)); }
            @include utils.when-focus { --_color-shade: calc(var(--color-shade, 0) + var(--focus-lift, 0.02)); }
            @include utils.when-focus-visible { --_color-shade: calc(var(--color-shade, 0) + var(--focus-lift, 0.02)); }
            @include utils.when-disabled { --_color-shade: calc(var(--color-shade, 0) + var(--disabled-shade, 0.1)); }
            @include utils.when-selected { --_color-shade: calc(var(--color-shade, 0) + var(--selected-shade, 0.04)); }
            @include utils.when-autofill { --_color-shade: calc(var(--color-shade, 0) + var(--autofill-shade, 0.04)); }

            // Placeholder
            &::placeholder {
                --on-surface-color: oklch(from --c2-on-surface(0, var(--color-source), #{$scheme-id}) l c h / 0.3);
            }

            // Autofill fix
            @include utils.when-autofill {
                &, &:hover, &:focus, &:active {
                    background-color: var(--surface-color) !important;
                }
            }

            // Selection
            @include utils.when-selected {
                background-color: var(--on-surface-color);
                color: var(--surface-color);
                -webkit-text-fill-color: var(--surface-color);
                --icon-color: var(--surface-color);
            }
        }

        &::picker(select) { background-color: transparent; }
    }
}

// =============================================================================
// CONVENIENCE MIXINS
// =============================================================================

@mixin surface($shade: 0) {
    @include solid-colorize("&", ("shade": $shade, "scope": "selector"));
}

@mixin surface-interactive($shade: 0) {
    @include solid-colorize("&", ("shade": $shade, "scope": "component"));
}

@mixin text-color($tint: 0) {
    color: --c2-on-surface($tint, var(--current, var(--primary, #469)));
}

@mixin border-color($tint: 0, $opacity: 0.2) {
    border-color: oklch(from --c2-on-surface($tint, var(--current, var(--primary, #469))) l c h / $opacity);
}

@mixin backdrop-blur($strength: "default") {
    @if $strength == "subtle" { backdrop-filter: var(--backdrop-blur-subtle); }
    @else if $strength == "strong" { backdrop-filter: var(--backdrop-blur-strong); }
    @else { backdrop-filter: var(--backdrop-blur-default); }
}

// =============================================================================
// LEGACY COMPATIBILITY
// =============================================================================

@mixin reset-vars($vars...) {
    @each $v in $vars { #{$v}: 0; }
}

@mixin tm-dep($property, $light, $dark) {
    #{$property}: color-mix(in oklch, #{$light} calc(100% * var(--tm-scheme)), #{$dark});
    @supports(color: light-dark(white, black)) { #{$property}: light-dark(#{$light}, #{$dark}); }
}

@function tm-hi($base, $percent) {
    @return color-mix(in oklch, #{$base} calc(100% - #{$percent}), var(--tm-hi, white));
}

@function tm-lo($base, $percent) {
    @return color-mix(in oklch, #{$base} calc(100% - #{$percent}), var(--tm-lo, black));
}

@mixin inverse {
    @include tm-dep("--tm-cr", var(--tm-cr-dark), var(--tm-cr-light));
    --tm-ac: #{tm-lo(var(--tm-origin, currentColor), 80%)};
}

@mixin veela-select-surface {
    background-color: var(--surface-color);
    border-color: var(--border-color);
    color: var(--on-surface-color);
    accent-color: currentColor;
    caret-color: currentColor;
    text-decoration-color: currentColor;
    text-emphasis-color: currentColor;
    scrollbar-color: var(--scrollbar-color) transparent;
    -webkit-text-fill-color: currentColor;
}

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

@function veela-state-shade($base, $delta: null) {
    @if $delta == null or $delta == 0 { @return $base; }
    @if meta.type-of($delta) == number {
        @return calc(#{$base} + (#{$delta} * var(--interaction-tone-direction, 1)));
    }
    @return $delta;
}

@function veela-selector-list($selectors) {
    @if meta.type-of($selectors) == string { @return $selectors; }
    @if meta.type-of($selectors) != list { @return $selectors; }

    $result: "";
    @for $i from 1 through list.length($selectors) {
        $separator: if($i > 1, ", ", "");
        $result: #{$result}#{$separator}#{list.nth($selectors, $i)};
    }
    @return $result;
}
