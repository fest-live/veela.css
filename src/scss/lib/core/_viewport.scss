@use "./logical" as lg;


@use "sass:string";


@mixin oriented($property, $portrait, $landscape) {
    & { #{$property}: #{$portrait}; }
    @media (orientation: portrait) { #{$property}: #{$portrait}; }
    @media (orientation: landscape) { #{$property}: #{$landscape}; }
}

@mixin compute_os_conditions {
    & {
        --in-rev-cond-x: calc(1 - #{lg.lor(lg.eq(var(--orient, 0), 0), lg.eq(var(--orient, 0), 1))});
        --in-rev-cond-y: calc(1 - #{lg.lor(lg.eq(var(--orient, 0), 0), lg.eq(var(--orient, 0), 3))});
        --in-swap-cond: #{_rem(var(--orient, 0), 2)};
        --in-rev-vx: calc(var(--in-rev-cond-x, 1) * -2 + 1);
        --in-rev-vy: calc(var(--in-rev-cond-y, 1) * -2 + 1);
    }
}

@mixin compute_os_size_to_cs {
    & {
        --cs-size-x: #{lg.mix(var(--os-size-x, 100cqb), var(--os-size-y, 100cqi), var(--in-swap-cond, 0))};
        --cs-size-y: #{lg.mix(var(--os-size-y, 100cqi), var(--os-size-x, 100cqb), var(--in-swap-cond, 0))};
        --cs-self-size-x: #{lg.mix(var(--os-self-size-y, 100cqb), var(--os-self-size-x, 100cqi), var(--in-swap-cond, 0))};
        --cs-self-size-y: #{lg.mix(var(--os-self-size-x, 100cqi), var(--os-self-size-y, 100cqb), var(--in-swap-cond, 0))};
    }
}

@mixin compute_cs_size_to_os {
    & {
        --os-size-x: #{lg.mix(var(--cs-size-x, 100cqi), var(--cs-size-y, 100cqb), var(--in-swap-cond, 0))};
        --os-size-y: #{lg.mix(var(--cs-size-y, 100cqb), var(--cs-size-x, 100cqi), var(--in-swap-cond, 0))};
        --os-self-size-x: #{lg.mix(var(--cs-self-size-y, 100cqb), var(--cs-self-size-x, 100cqi), var(--in-swap-cond, 0))};
        --os-self-size-y: #{lg.mix(var(--cs-self-size-x, 100cqi), var(--cs-self-size-y, 100cqb), var(--in-swap-cond, 0))};
    }
}

@mixin compute_from_os_to_cs {
    & {
        --in-inset-x: #{lg.mix(var(--os-inset-x, 0px), var(--os-inset-y, 0px), var(--in-swap-cond, 0))};
        --in-inset-y: #{lg.mix(var(--os-inset-y, 0px), var(--os-inset-x, 0px), var(--in-swap-cond, 0))};
        --in-drag-x: #{lg.mix(var(--os-drag-x, 0px), var(--os-drag-y, 0px), var(--in-swap-cond, 0))};
        --in-drag-y: #{lg.mix(var(--os-drag-y, 0px), var(--os-drag-x, 0px), var(--in-swap-cond, 0))};
    }

    & {
        --cs-inset-x: #{lg.mix(var(--in-inset-x, 0px), calc(var(--cs-size-x, 100cqi) - var(--in-inset-x, 0px)), var(--in-rev-cond-x, 0))};
        --cs-inset-y: #{lg.mix(var(--in-inset-y, 0px), calc(var(--cs-size-y, 100cqb) - var(--in-inset-y, 0px)), var(--in-rev-cond-y, 0))};
        --cs-drag-x: calc(var(--in-drag-x, 0px) * var(--in-rev-vx, 1));
        --cs-drag-y: calc(var(--in-drag-y, 0px) * var(--in-rev-vy, 1));
    }
}

@mixin compute_from_cs_to_os {
    & {
        --in-inset-x: #{lg.mix(var(--cs-inset-x, 0px), calc(var(--cs-size-x, 100cqi) - var(--cs-inset-x, 0px)), var(--in-rev-cond-x, 0))};
        --in-inset-y: #{lg.mix(var(--cs-inset-y, 0px), calc(var(--cs-size-y, 100cqi) - var(--cs-inset-y, 0px)), var(--in-rev-cond-y, 0))};
        --in-drag-x: calc(var(--cs-drag-x, 0px) * var(--in-rev-vx, 1));
        --in-drag-y: calc(var(--cs-drag-y, 0px) * var(--in-rev-vy, 1));
    }

    & {
        --os-inset-x: #{lg.mix(var(--in-inset-x, 0px), var(--in-inset-y, 0px), var(--in-swap-cond, 0))};
        --os-inset-y: #{lg.mix(var(--in-inset-y, 0px), var(--in-inset-x, 0px), var(--in-swap-cond, 0))};
        --os-drag-x: #{lg.mix(var(--in-drag-y, 0px), var(--in-drag-x, 0px), var(--in-swap-cond, 0))};
        --os-drag-y: #{lg.mix(var(--in-drag-x, 0px), var(--in-drag-y, 0px), var(--in-swap-cond, 0))};
    }
}

@mixin portrait-size {
    --cqi: 100cqmin;
    --cqb: 100cqmax;
}

@mixin landscape-size {
    --cqi: 100cqmax;
    --cqb: 100cqmin;
}

@mixin init-os-size-by-native {
    --os-size-x: var(--cqi, 100cqi);
    --os-size-y: var(--cqb, 100cqb);
}

@mixin init-cs-size {
    --cs-size-x: 100cqw;
    --cs-size-y: 100cqh;
}

@mixin centered-self($transforms: null) {
    transform-origin: 0% 0%;
    transform:
        #{$transforms}
        scale3d(var(--scale, 1), var(--scale, 1), var(--scale, 1))
        #{perfect-translate(calc(var(--translate-x, 0px) - 50%), calc(var(--translate-y, 0px) - 50%))};
    place-self: center;
}

@mixin centered-with-offset {
    $translate: #{perfect-translate(var(--cs-drag-x, 0px), var(--cs-drag-y, 0px))};
    @include centered-self($translate);
}

@mixin use-inset {
    inset: var(--cs-inset-y, 0px) auto auto var(--cs-inset-x, 0px);
}

@function _rem($value, $mod) {
    @return string.unquote("rem(#{$value}, #{$mod})");
}


//
@mixin use_dvp {
    & { --avi: 100dvmin; --avb: 100dvmax; };
    & {
        --vp-i-size: var(--avi, 100dvmin);
        --vp-b-size: var(--avb, 100dvmax);
    }
}

//
@mixin use_lvp {
    & { --avi: 100lvmin; --avb: 100lvmax; };
    & {
        --vp-i-size: var(--avi, 100lvmin);
        --vp-b-size: var(--avb, 100lvmax);
    }
}


//
@mixin when-fullscreen($selector: &) {
    @media (display-mode: fullscreen) { @content; }
    @at-root :fullscreen #{$selector} { @content; }
}

//
@mixin vp-vars {
    @include use_dvp();
    @include when-fullscreen() {
        @include use_lvp();
        & {
            --vp-i-size: min(var(--avail-width, 100dvmin), 100dvmin);
            --vp-b-size: min(var(--avail-height, 100dvmax), 100dvmax);
        }
    }
};

//
@mixin fit-viewport {
    @include vp-vars;
    & {
        @include oriented(inline-size, var(--vp-i-size, 100lvi), var(--vp-b-size, 100lvb));
        @include oriented(block-size, var(--vp-b-size, 100lvb), var(--vp-i-size, 100lvi));
        @include oriented(max-inline-size, var(--vp-i-size, 100lvi), var(--vp-b-size, 100lvb));
        @include oriented(max-block-size, var(--vp-b-size, 100lvb), var(--vp-i-size, 100lvi));
    }
};

//
@function perfect-translate($x: 0px, $y: 0px) {
    @return translate3d(round(nearest, #{$x}, calc(1px / var(--pixel-ratio, 1))), round(nearest, #{$y}, calc(1px / var(--pixel-ratio, 1))), 0);
}

//
@mixin compute_grid_item_cell() {
    & {
        --p-cell-x: var(--cell-x);
        --p-cell-y: var(--cell-y);

        // CLAMPED GRID
        --f-col: clamp(4, var(--layout-c, 4), 6);
        --f-row: clamp(8, var(--layout-r, 8), 12);

        //
        --fc-cell-x: calc(clamp(0, var(--cell-x), calc(var(--f-col) - 1)) + 1);
        --fc-cell-y: calc(clamp(0, var(--cell-y), calc(var(--f-row) - 1)) + 1);

        //
        --fp-cell-x: calc(clamp(0, var(--p-cell-x), calc(var(--f-col) - 1)) + 1);
        --fp-cell-y: calc(clamp(0, var(--p-cell-y), calc(var(--f-row) - 1)) + 1);

        //
        --dir-x: calc(var(--fc-cell-x) - var(--fp-cell-x));
        --dir-y: calc(var(--fc-cell-y) - var(--fp-cell-y));

        //
        --grid-c: var(--fc-cell-x);
        --grid-r: var(--fc-cell-y);
    }

    & {
        --ox-c-unit:  calc(var(--os-size-x, 100cqi) / var(--os-layout-c, 1));
        --ox-r-unit:  calc(var(--os-size-y, 100cqb) / var(--os-layout-r, 1));
        --os-inset-x: calc((var(--grid-c, 1) - 0.5) * var(--ox-c-unit, 1px));
        --os-inset-y: calc((var(--grid-r, 1) - 0.5) * var(--ox-r-unit, 1px));
    }
}

//
@mixin compute_orient_grid_layout() {
    & {
        --os-layout-c: var(--layout-c, 4);
        --os-layout-r: var(--layout-r, 8);

        //
        --cs-layout-c: #{lg.mix(var(--os-layout-c, 4), var(--os-layout-r, 8), var(--in-swap-cond, 0))};
        --cs-layout-r: #{lg.mix(var(--os-layout-r, 8), var(--os-layout-c, 4), var(--in-swap-cond, 0))};
    }

    & > :where(*) {
        // hack: use translate diff shifting for correct animation for CSS Grid Layout
        & { // currently, I have no viable solution for correct animation for CSS Grid Layout
            --cs-sw-unit-x: #{lg.mix(var(--ox-c-unit, 1px), var(--ox-r-unit, 1px), var(--in-swap-cond, 0))};
            --cs-sw-unit-y: #{lg.mix(var(--ox-r-unit, 1px), var(--ox-c-unit, 1px), var(--in-swap-cond, 0))};

            //
            --cs-transition-c: calc((var(--cs-inset-x, 0px) - (round(nearest, var(--cs-grid-c, 1), 1) - 0.5) * var(--cs-sw-unit-x, 1px)));
            --cs-transition-r: calc((var(--cs-inset-y, 0px) - (round(nearest, var(--cs-grid-r, 1), 1) - 0.5) * var(--cs-sw-unit-y, 1px)));
        }

        //
        & { // compute oriented grid cell to client-space coordinates
            --os-grid-c: var(--grid-c, 1);
            --os-grid-r: var(--grid-r, 1);

            // needs re-orient by...
            --in-grid-c: #{lg.mix(var(--os-grid-c, 1), var(--os-grid-r, 1), var(--in-swap-cond, 0))};
            --in-grid-r: #{lg.mix(var(--os-grid-r, 1), var(--os-grid-c, 1), var(--in-swap-cond, 0))};

            //
            --cs-grid-c: #{lg.mix(var(--in-grid-c, 1), calc(var(--cs-layout-c, 4) - (var(--in-grid-c, 1) - 1)), var(--in-rev-cond-x, 0))};
            --cs-grid-r: #{lg.mix(var(--in-grid-r, 1), calc(var(--cs-layout-r, 8) - (var(--in-grid-r, 1) - 1)), var(--in-rev-cond-y, 0))};
        }
    }
}
