@use "sass:map";
@use "sass:meta";
@use "sass:list";
@use "sass:string";

//
@use "./color" as color;
@use "./logical" as lg;
@use "./utils" as prop;

//
@mixin _apply-surface-palette($selectors, $color: var(--on-surface-color, currentColor), $set-icon: false) {
    #{$selectors} {
        border-color: var(--border-color, transparent);
        background-color: var(--surface-color, transparent);
        color: #{$color};
        accent-color: #{$color};
        caret-color: #{$color};
        text-decoration-color: #{$color};
        text-emphasis-color: #{$color};
        scrollbar-color: var(--scrollbar-color) transparent;
        -webkit-text-fill-color: currentColor;

        @if $set-icon {
            --icon-color: #{$color};
        }
    }
}

//
@mixin reset-vars($vars...) { @each $v in $vars { #{$v}: 0; } }
@mixin tm-dep($property, $light, $dark) {
    & {
        #{$property}: color-mix(in oklch, #{$light} calc(100% * var(--tm-scheme)), #{$dark});
        @supports(color: light-dark(white, black)) { #{$property}: light-dark(#{$light}, #{$dark}); }
    }
}

//
@mixin inverse {
    & {
        @include tm-dep("--tm-cr", var(--tm-cr-dark), var(--tm-cr-light));
        --tm-ac: #{tm-lo(var(--tm-origin, currentColor), 80%)};
    }
}

//
@function tm-hi($base, $percent) { @return color-mix(in oklch, #{$base} calc(100% - #{$percent}), var(--tm-hi, white)); }
@function tm-lo($base, $percent) { @return color-mix(in oklch, #{$base} calc(100% - #{$percent}), var(--tm-lo, black)); }

// Internal helpers
@function _merge-color-options($defaults, $overrides) {
    @if $overrides == null or meta.type-of($overrides) != "map" or list.length($overrides) == 0 {
        @return $defaults;
    }

    @return map.merge($defaults, $overrides);
}

// Enhanced colorize mixin with scoped propagation options
@mixin solid-colorize(
    $selector: "&",
    $options: (
        "shade": 0.0,
        "tint": 0.0,
        "scheme-id": 2,
        "role": null,
        "scope": "component",
        "propagate": null,
        "forms-background": null,
        "global-targets": null
    )
) {
    $role: map.get($options, "role");
    $base-shade: prop.option-or($options, "shade", 0.0);
    $base-tint: prop.option-or($options, "tint", 0.0);
    $scheme-id: prop.option-or($options, "scheme-id", 2);
    $scope: prop.option-or($options, "scope", "component");
    $propagate-default: if($scope == "selector", false, true);
    $propagate: prop.option-or($options, "propagate", $propagate-default);
    $forms-background: prop.option-or($options, "forms-background", $propagate);
    $global-targets: prop.option-or($options, "global-targets", $propagate);

    #{$selector} {
        --color-shade: #{$base-shade};
        --color-tint: #{$base-tint};
        --color-source: var(--current, var(--primary, transparent));
        --surface-color: --c2-surface(
            var(--color-shade, 0),
            var(--color-source, var(--current, transparent)),
            #{$scheme-id}
        );
        --on-surface-color: --c2-on-surface(
            var(--color-tint, 0),
            var(--color-source, var(--current, currentColor)),
            #{$scheme-id}
        );
        --on-surface: var(--on-surface-color, currentColor); // alias
        --scrollbar-color: oklch(from var(--on-surface-color, currentColor) l c h / 0.4);
        --border-color: oklch(
            from --c2-surface(
                calc(var(--color-shade, 0) + var(--color-tint, 0) + 0.05),
                var(--color-source, var(--current, var(--primary, transparent))),
                #{$scheme-id}
            ) l c h / 0.1
        );

        &:where(a, span, ui-icon) {
            @include _apply-surface-palette("&", var(--on-surface-color, currentColor), true);
            --icon-color: var(--on-surface-color, currentColor);

            //
            &::selection {
                color: var(--surface-color, currentColor);
                --icon-color: var(--surface-color, currentColor);
            }
        }

        &:where(button, input, select, textarea) {
            border-style: solid;
            border-width: 0.5px;
        }

        @include _apply-surface-palette("&", var(--on-surface-color, currentColor), true);
        @include _apply-surface-palette("&::picker(select)", var(--on-surface-color, currentColor));

        @if $propagate {
            @include _apply-surface-palette("& :where(select)", var(--on-surface-color, currentColor));
        }

        $interactive-scope: if(
            $propagate,
            "&:where(button, input, select, textarea, option), & :where(button, input, select, textarea, option)",
            "&:where(button, input, select, textarea, option)"
        );

        #{$interactive-scope} {
            @if $propagate {
                @include _apply-surface-palette("&", var(--on-surface-color, currentColor), true);
            }

            //
            @if $forms-background {
                background-color: color-mix(
                    in oklch,
                    var(--surface-color, transparent) 90%,
                    var(--on-surface-color, transparent) 10%
                );
            }

            //
            transition:
                border-color var(--transition-normal),
                background var(--transition-normal),
                box-shadow var(--transition-normal),
                transform var(--transition-fast);

            //
            &:hover { --color-shade: calc(#{$base-shade} + var(--hover-lift, 0.04)); }
            &:active { --color-shade: calc(#{$base-shade} + var(--active-lift, 0.06)); }
            &:is(:focus, :focus-visible) { --color-shade: calc(#{$base-shade} + var(--focus-lift, 0.02)); }

            //
            &::placeholder {
                --on-surface-color: oklch(
                    from --c2-on-surface(
                        0.0,
                        var(--color-source, var(--current, var(--primary, transparent))),
                        #{$scheme-id}
                    ) l c h / 0.2
                );
            }

            //
            &:disabled { --color-shade: calc(#{$base-shade} + var(--disabled-shade, 0.1)); }

            //
            &:is(::selection, :checked) {
                background-color: var(--on-surface-color, transparent);
                color: var(--surface-color, currentColor);
                -webkit-text-fill-color: var(--surface-color, currentColor);
                --icon-color: var(--surface-color, currentColor);
            }
        }

        &::picker(select) {
            background-color: transparent;
        }

        @if $global-targets {
            ::picker(select) {
                background-color: transparent;
            }
        }

        @if $global-targets {
            ui-icon {
                background-color: transparent;
                --icon-color: var(--on-surface-color, currentColor);
            }
        }

        //
        &:where(a, span, ui-icon) {
            background-color: transparent;
            &::selection { background-color: var(--on-surface-color, transparent); }
        }

        //
        @if $global-targets {
            :where(a, span, ui-icon) {
                background-color: transparent;
                &::selection { background-color: var(--on-surface-color, transparent); }
            }
        }
    }
}



//
@mixin veela-select-surface() {
    background-color: var(--surface-color);
    border-color: var(--border-color);
    color: var(--on-surface-color);
    accent-color: currentColor;
    caret-color: currentColor;
    text-decoration-color: currentColor;
    text-emphasis-color: currentColor;
    scrollbar-color: var(--scrollbar-color) transparent;
    -webkit-text-fill-color: currentColor;
}

//
@mixin surface($shade: var(--surface-opacity-default)) {
    @include solid-colorize("&", ("shade": $shade, "tint": 0.0));
}

//
@mixin surface-interactive($shade: var(--surface-opacity-default)) {
    @include solid-colorize("&", ("shade": $shade, "tint": 0.0));
}

//
@mixin text-color($tint: var(--text-tint-primary)) {
    color: --c2-on-surface($tint, var(--current, var(--color-on-surface, var(--md-on-surface, #1c1b1f))));
}

//
@mixin border-color($tint: var(--scrollbar-tint), $opacity: var(--border-opacity-default)) {
    border-color: oklch(
        from --c2-on-surface(
            $tint,
            var(--current, var(--color-on-surface, var(--md-on-surface, #1c1b1f)))
        ) l c h / $opacity
    );
}

//
@mixin backdrop-blur($strength: "default") {
    @if $strength =="subtle" {
        backdrop-filter: var(--backdrop-blur-subtle);
    }

    @else if $strength =="strong" {
        backdrop-filter: var(--backdrop-blur-strong);
    }

    @else {
        backdrop-filter: var(--backdrop-blur-default);
    }
}

//
@function veela-state-shade($base, $delta: null) {
    @if $delta == null or $delta == 0 {
        @return $base;
    }

    @if meta.type-of($delta) == number {
        $direction: var(--interaction-tone-direction, 1);
        @return calc(#{$base} + (#{$delta} * #{$direction}));
    }

    @return $delta;
}

//
@function veela-selector-list($selectors) {
    @if meta.type-of($selectors) == string {
        @return $selectors;
    }

    $result: "";

    @if meta.type-of($selectors) == list {
        @for $i from 1 through list.length($selectors) {
            $separator: if($i > 1, ", ", "");
            $result: #{$result}#{$separator}#{list.nth($selectors, $i)};
        }

        @return $result;
    }

    @return $selectors;
}

//
@mixin veela-interactive(
    $base,
    $hover: null,
    $focus: null,
    $active: null,
    $hover-selectors: (":hover"),
    $focus-selectors: (":focus", ":focus-visible"),
    $active-selectors: (":active"),
    $disabled-shade: null,
    $disabled-opacity: null,
    $disabled-selectors: (":disabled"),
    $outline-size: 2px,
    $outline-offset: 2px,
    $outline-alpha: var(--outline-opacity),
    $outline-enabled: true
) {
    @if $hover != null {
        &:where(#{veela-selector-list($hover-selectors)}):not(:disabled) {
            --color-shade: veela-state-shade($base, $hover);
        }
    }

    @if $focus != null {
        &:where(#{veela-selector-list($focus-selectors)}):not(:disabled) {
            --color-shade: veela-state-shade($base, $focus);

            @if $outline-enabled {
                outline: $outline-size solid oklch(from var(--current) l c h / #{$outline-alpha});
                outline-offset: $outline-offset;
            }
        }
    }

    @if $active != null {
        &:where(#{veela-selector-list($active-selectors)}):not(:disabled) {
            --color-shade: veela-state-shade($base, $active);
        }
    }

    @if $disabled-shade != null or $disabled-opacity != null {
        &:where(#{veela-selector-list($disabled-selectors)}) {
            @if $disabled-shade != null {
                --color-shade: veela-state-shade($base, $disabled-shade);
            }

            @if $disabled-opacity != null {
                opacity: $disabled-opacity;
            }
        }
    }
}
