@use "sass:list";
@use "sass:map";
@use "sass:meta";

@use "./colorize" as colorize;
@use "./motion" as motion;
@use "./shadow" as shadow;

// =============================================================================
// VISUAL EFFECTS MIXINS (split from layout)
// =============================================================================

$effect-defaults: (
    transition-duration: var(--duration-fast, #{motion.$ui-duration-fast}),
    transition-timing: var(--ease-out, #{motion.$ui-ease-standard}),
    lift: -2px,
    scale: 1,
    hover-shadow: var(--shadow-md, #{shadow.$shadow-md}),
    glass-surface-opacity: var(--surface-opacity-muted, 0.06),
    glass-border-opacity: var(--border-opacity-subtle, 0.14),
    glass-blur: default,
    shimmer-angle: 112deg,
    shimmer-width: 28%,
    shimmer-opacity: 0.32,
    shimmer-duration: var(--duration-long, #{motion.$ui-duration-standard}),
    shimmer-color: color-mix(in oklch, var(--color-primary, #ffffff) 36%, transparent),
    shine-duration: var(--duration-normal, #{motion.$ui-duration-standard}),
    shine-angle: 95deg,
    shine-width: 22%,
    shine-opacity: 0.28
);

$__effects-shimmer-keyframes-declared: false !default;
$shimmer-keyframes-name: veela-shimmer-glide;

@function _effect-token($token) {
    @if map.has-key($effect-defaults, $token) {
        @return map.get($effect-defaults, $token);
    }

    @error "Unknown visual effect token `#{$token}`.";
}

@mixin _ensure-shimmer-keyframes($name: $shimmer-keyframes-name) {
    @if not $__effects-shimmer-keyframes-declared {
        $__effects-shimmer-keyframes-declared: true !global;

        @at-root {
            @keyframes #{$name} {
                0% { transform: translate3d(-120%, 0, 0); }
                50% { transform: translate3d(0, 0, 0); }
                100% { transform: translate3d(120%, 0, 0); }
            }
        }
    }
}

@mixin effect-transition($properties: (transform, box-shadow), $duration: null, $timing: null) {
    $prop-list: if(meta.type-of($properties) == "list", $properties, ($properties,));
    $resolved-duration: if($duration == null, _effect-token(transition-duration), $duration);
    $resolved-timing: if($timing == null, _effect-token(transition-timing), $timing);

    @include motion.transition($prop-list, $resolved-duration, $resolved-timing);
}

@mixin interactive-effect(
    $hover-transform: null,
    $hover-shadow: null,
    $rest-shadow: null,
    $properties: (transform, box-shadow),
    $duration: null,
    $timing: null
) {
    $prop-list: if(meta.type-of($properties) == "list", $properties, ($properties,));

    @include effect-transition($prop-list, $duration, $timing);

    @if $rest-shadow != null {
        box-shadow: $rest-shadow;
    }

    &:hover {
        @if $hover-transform != null {
            transform: $hover-transform;
        }

        @if $hover-shadow != null {
            box-shadow: $hover-shadow;
        }
    }
}

@mixin glass-morphism(
    $surface-opacity: null,
    $border-opacity: null,
    $blur: null
) {
    $surface-opacity: if($surface-opacity == null, _effect-token(glass-surface-opacity), $surface-opacity);
    $border-opacity: if($border-opacity == null, _effect-token(glass-border-opacity), $border-opacity);
    $blur-value: if($blur == null, _effect-token(glass-blur), $blur);

    @include colorize.surface($surface-opacity);
    @include colorize.border-color(var(--scrollbar-tint), $border-opacity);

    @if meta.type-of($blur-value) == "string" {
        @include colorize.backdrop-blur($blur-value);
    } @else {
        backdrop-filter: $blur-value;
    }

    background-color:
        color-mix(
            in oklch,
            var(--surface-color, var(--md-sys-color-surface, #0f131a)) calc(#{$surface-opacity} * 100%),
            transparent
        );
}

@mixin gradient-text($gradient: var(--primary-gradient, linear-gradient(120deg, var(--color-primary, #6b8cff), var(--color-tertiary, #f86ed4)))) {
    background-image: $gradient;
    background-size: 200% 200%;
    background-position: 0% 50%;
    background-clip: text;
    color: transparent;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;

    @include effect-transition(background-position);

    &:hover {
        background-position: 100% 50%;
    }
}

@mixin hover-lift(
    $lift: null,
    $shadow: null,
    $scale: null,
    $rest-shadow: null,
    $duration: null,
    $timing: null
) {
    $resolved-lift: if($lift == null, _effect-token(lift), $lift);
    $resolved-shadow: if($shadow == null, _effect-token(hover-shadow), $shadow);
    $resolved-scale: if($scale == null, _effect-token(scale), $scale);

    $hover-transform: translate3d(0, $resolved-lift, 0);

    @if $resolved-scale != 1 {
        $hover-transform: #{$hover-transform} scale(#{$resolved-scale});
    }

    @include interactive-effect(
        $hover-transform: $hover-transform,
        $hover-shadow: $resolved-shadow,
        $rest-shadow: $rest-shadow,
        $properties: (transform, box-shadow),
        $duration: $duration,
        $timing: $timing
    );
}

@mixin shimmer-effect(
    $duration: null,
    $angle: null,
    $width: null,
    $opacity: null,
    $color: null
) {
    $resolved-duration: if($duration == null, _effect-token(shimmer-duration), $duration);
    $resolved-angle: if($angle == null, _effect-token(shimmer-angle), $angle);
    $resolved-width: if($width == null, _effect-token(shimmer-width), $width);
    $resolved-opacity: if($opacity == null, _effect-token(shimmer-opacity), $opacity);
    $resolved-color: if($color == null, _effect-token(shimmer-color), $color);

    position: relative;
    overflow: hidden;
    isolation: isolate;

    @include effect-transition(filter);

    @include _ensure-shimmer-keyframes();

    &::after {
        content: "";
        position: absolute;
        inset: -150%;
        background: linear-gradient(
            $resolved-angle,
            transparent 0%,
            color-mix(in oklch, #{$resolved-color} 0%, transparent) calc((100% - #{$resolved-width}) / 2),
            #{$resolved-color} 50%,
            color-mix(in oklch, #{$resolved-color} 0%, transparent) calc((100% + #{$resolved-width}) / 2),
            transparent 100%
        );
        opacity: $resolved-opacity;
        animation: #{$shimmer-keyframes-name} #{$resolved-duration} linear infinite;
        pointer-events: none;
        mix-blend-mode: screen;
    }

    @include motion.reduced-motion {
        &::after {
            animation-play-state: paused;
            opacity: calc(#{$resolved-opacity} * 0.7);
        }
    }
}

@mixin button-shine(
    $duration: null,
    $angle: null,
    $width: null,
    $opacity: null,
    $shadow: null
) {
    $resolved-duration: if($duration == null, _effect-token(shine-duration), $duration);
    $resolved-angle: if($angle == null, _effect-token(shine-angle), $angle);
    $resolved-width: if($width == null, _effect-token(shine-width), $width);
    $resolved-opacity: if($opacity == null, _effect-token(shine-opacity), $opacity);
    $resolved-shadow: if($shadow == null, _effect-token(hover-shadow), $shadow);

    position: relative;
    overflow: hidden;
    isolation: isolate;

    @include hover-lift(
        $shadow: $resolved-shadow,
        $rest-shadow: var(--shadow-sm, #{shadow.$shadow-sm})
    );

    &::before {
        content: "";
        position: absolute;
        inset-block: -30%;
        inset-inline: calc(-1 * #{$resolved-width});
        background: linear-gradient(
            $resolved-angle,
            transparent 0%,
            rgb(255 255 255 / 0) calc((100% - #{$resolved-width}) / 2),
            rgb(255 255 255 / #{$resolved-opacity}) 50%,
            rgb(255 255 255 / 0) calc((100% + #{$resolved-width}) / 2),
            transparent 100%
        );
        transform: translate3d(-120%, 0, 0);
        transition: transform #{$resolved-duration} var(--ease-in-out, #{motion.md3-easing(standard)});
        pointer-events: none;
        mix-blend-mode: soft-light;
    }

    &:hover::before,
    &:focus-visible::before {
        transform: translate3d(120%, 0, 0);
    }

    @include motion.reduced-motion {
        &::before {
            transition-duration: calc(#{$resolved-duration} * 1.5);
        }
    }
}

