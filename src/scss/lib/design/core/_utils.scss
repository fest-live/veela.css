@use "sass:list";
@use "sass:map";
@use "sass:math";
@use "sass:meta";
@use "sass:string";

//
@function option-or($options, $key, $fallback) {
    $value: map.get($options, $key);
    @return if($value == null, $fallback, $value);
}

//
// Fetch function
@function md3-fetch($source, $token, $label: "token") {
    @if map.has-key($source, $token) {
        @return map.get($source, $token);
    }

    @error "Unknown #{$label} `#{$token}`. Available: #{map.keys($source)}";
}

//
@mixin when-hover($selector: "&") {
    @media (hover: hover) and (pointer: fine) { #{$selector}:hover { @content; } }
    @media (hover: none) and (pointer: coarse) { #{$selector}:active { @content; } }
}

//
@mixin when-active($selector: "&") {
    @media (hover: hover) and (pointer: fine) { #{$selector}:active { @content; } }
}

//
@mixin when-focus($selector: "&") {
    @media (hover: hover) and (pointer: fine) { #{$selector}:focus-visible { @content; } }
    @media (hover: none) and (pointer: coarse) { #{$selector}:focus { @content; } }
}

//
@mixin when-focus-visible($selector: "&") {
    @media (hover: hover) and (pointer: fine) { #{$selector}:focus-visible { @content; } }
    @media (hover: none) and (pointer: coarse) { #{$selector}:focus-visible { @content; } }
}

//
@mixin when-disabled($selector: "&") {
    @media (hover: hover) and (pointer: fine) { #{$selector}:disabled, #{$selector}[aria-disabled="true"] { @content; } }
    @media (hover: none) and (pointer: coarse) { #{$selector}:disabled, #{$selector}[aria-disabled="true"] { @content; } }
}

//
@mixin when-selected($selector: "&") {
    @media (hover: hover) and (pointer: fine) { #{$selector}::selection, #{$selector}:checked, #{$selector}[aria-selected="true"] { @content; } }
    @media (hover: none) and (pointer: coarse) { #{$selector}::selection, #{$selector}:checked, #{$selector}[aria-selected="true"] { @content; } }
}

//
@mixin when-autofill($selector: "&") {
    #{$selector}:-webkit-autofill { @content; }
    #{$selector}:autofill { @content; }
    #{$selector}:auto-fill { @content; }
}

// State layer mixin
@mixin md3-state-layer($role: primary, $state: hover, $selector: "&::after") {
    $opacity: md3-opacity-state($state);
    $role-var: md3-var($role);
    $weight: calc(100% * #{$opacity});//math.percentage($opacity);

    @if $selector == "&::after" or $selector == "&::before" {
        position: relative;
        overflow: hidden;
    }

    #{$selector} {
        content: "";
        position: absolute;
        inset: 0;
        background-color: color-mix(in oklch, var(#{$role-var}) #{$weight}, transparent);
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--duration-fast) var(--ease-out);
    }

    @include when-hover {
        #{$selector} { opacity: $opacity; }
    }

    @include when-active {
        #{$selector} { opacity: $opacity; }
    }

    @include when-focus {
        #{$selector} { opacity: $opacity; }
    }

    @include when-focus-visible {
        #{$selector} { opacity: $opacity; }
    }

    @include when-disabled {
        #{$selector} { opacity: $opacity; }
    }

    @include when-selected {
        #{$selector} { opacity: $opacity; }
    }
}

@mixin hover($selector: "&") {
    @include when-hover { #{$selector}:hover { @content; } }
    @include when-active { #{$selector}:active { @content; } }
}



///
/// Registers a single CSS Custom Property via the Properties & Values API.
/// Accepts either:
/// - a map: ("syntax": "<color>", "initial": currentColor, "inherits": false)
/// - or explicit keyword arguments via a map provided with merge utilities.
///
/// Supported keys:
/// - syntax: string value describing the syntax
/// - initial or initial-value: default value for the property
/// - inherits: boolean flag (defaults to true)
///
@mixin register-property($name, $definition) {
    $config: if(meta.type-of($definition) == "map", $definition, ());

    $defaultByType: (
        "integer": 0,
        "number": 0.0,
        "color": #0000,
        "boolean": false,
        "string": "",
        "length": 0px,
        "length-percentage": 0px,
        "angle": 0deg
    );

    $syntax: map.get($config, "syntax") or "<number>";
    $initial: if(
        map.has-key($config, "initial-value"),
        map.get($config, "initial-value"),
        map.get($config, "initial")
    ) or option-or($defaultByType, $syntax, 0.0);
    $inherits: if(map.has-key($config, "inherits"), map.get($config, "inherits"), true);

    @property #{$name} {
        @if $syntax != null { syntax: "#{$syntax}"; }
        @if $inherits != null { inherits: $inherits; }
        @if $initial != null { initial-value: #{$initial}; }
    }
}

///
/// Registers multiple CSS Custom Properties at once.
/// Accepts any number of maps. Each map entry should follow the format used by `register-property`.
///
@mixin register-properties($bundles...) {
    @each $bundle in $bundles {
        @if meta.type-of($bundle) == "map" {
            @each $name, $definition in $bundle {
                @include register-property($name, $definition);
            }
        } @else if $bundle != null {
            @warn "register-properties expects map entries, received #{meta.type-of($bundle)}.";
        }
    }
}

