@use "sass:map";

//
@use "../../../core/layout" as layout;

//
@use "./typography" as type;
@use "./constants" as tokens;
@use "./colorize" as colorize;
@use "./animation" as animation;

// -----------------------------------------------------------------------------
// Shared base styles
// -----------------------------------------------------------------------------

@mixin button-structure() {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    place-items: center;
    place-content: center;
    gap: var(--button-gap, var(--gap-sm));
    padding-block: var(--button-padding-y, var(--padding-sm));
    padding-inline: var(--button-padding-x, var(--padding-lg));
    min-block-size: var(--button-min-height, 2.75rem);
    border-radius: var(--button-radius, var(--radius-full));
    cursor: pointer;
    transition:
        var(--transition-transform, transform var(--duration-fast) var(--ease-out)),
        var(--transition-colors, color var(--duration-normal) var(--ease-out), background-color var(--duration-normal) var(--ease-out)),
        var(--transition-opacity, opacity var(--duration-normal) var(--ease-out));

    pointer-events: auto;
    margin: 0;
    border: none;
    outline: none;
    position: relative;
    isolation: isolate;

    @include type.type("label-large");
    letter-spacing: 0.01em;
    text-decoration: none;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    user-select: none;

    block-size: fit-content;
    inline-size: fit-content;
    max-block-size: stretch;
    max-inline-size: stretch;
    flex-wrap: nowrap;

    &:disabled {
        opacity: var(--state-opacity-disabled, 0.38);
        pointer-events: none;
    }

    & > * { max-inline-size: stretch; }

    & :where(span, a) {
        display: inline;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        flex-wrap: nowrap;
    }
}

@mixin button-overlays($fallback-color) {
    --md3-button-state-color: var(--md3-button-state-color, #{$fallback-color});
    position: relative;
    overflow: hidden;

    &::after,
    &::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        mix-blend-mode: normal;
    }

    &::after {
        opacity: 0;
        transition: opacity var(--duration-normal) var(--ease-out);
        background: color-mix(
            in oklch,
            var(--md3-button-state-color, #{$fallback-color}) calc(var(--state-opacity-hover, 0.08) * 100%),
            transparent
        );
    }

    &::before {
        opacity: 0;
        transition: opacity var(--duration-fast) var(--ease-out);
        background: color-mix(
            in oklch,
            var(--md3-button-state-color, #{$fallback-color}) calc(var(--state-opacity-press, 0.12) * 100%),
            transparent
        );
    }

    &:hover::after,
    &:focus-visible::after { opacity: 1; }

    &:active::before { opacity: 1; }
}

@mixin button-focus-ring() {
    &:focus-visible {
        outline: 2px solid color-mix(
            in oklch,
            var(--md3-button-state-color, var(--md3-primary)) calc(var(--state-opacity-focus, 0.12) * 100%),
            transparent
        );
        outline-offset: 3px;
    }
}

@mixin button-shadow($shadow) {
    --md3-button-shadow: #{$shadow};
    box-shadow: var(--md3-button-shadow, none);
}

// -----------------------------------------------------------------------------
// Variant mixins
// -----------------------------------------------------------------------------

@mixin button-filled($role: primary, $include-base: true) {
    @if $include-base { @include button-structure(); }

    $bg-var: tokens.md3-var($role);
    $on-var: tokens.md3-var(tokens.md3-on($role));

    --md3-button-bg: var(--md3-button-bg, var(#{$bg-var}));
    --md3-button-on: var(--md3-button-on, var(#{$on-var}));
    --md3-button-outline-color: var(--md3-button-outline-color, var(#{tokens.md3-var(outline)}));
    @include button-shadow(none);

    background-color: var(--md3-button-bg);
    color: var(--md3-button-on);
    border: none;

    @include button-overlays(var(#{$bg-var}));
    @include button-focus-ring();
}

@mixin button-elevated($role: primary, $include-base: true) {
    @if $include-base { @include button-structure(); }

    $state-var: tokens.md3-var($role);

    --md3-button-bg: var(--md3-button-bg, var(#{tokens.md3-var(surface)}));
    --md3-button-on: var(--md3-button-on, var(#{tokens.md3-var(on-surface)}));
    --md3-button-outline-color: var(--md3-button-outline-color, var(#{tokens.md3-var(outline-variant)}));
    @include button-shadow(tokens.md3-elevation(2));

    background-color: var(--md3-button-bg);
    color: var(--md3-button-on);
    border: none;

    @include button-overlays(var(#{$state-var}));
    @include button-focus-ring();
}

@mixin button-tonal($container-role: secondary-container, $state-role: secondary, $include-base: true) {
    @if $include-base { @include button-structure(); }

    $container-var: tokens.md3-var($container-role);
    $on-var: tokens.md3-var(tokens.md3-on($container-role));
    $state-var: tokens.md3-var($state-role);

    --md3-button-bg: var(--md3-button-bg, var(#{$container-var}));
    --md3-button-on: var(--md3-button-on, var(#{$on-var}));
    --md3-button-outline-color: var(--md3-button-outline-color, transparent);
    @include button-shadow(none);

    background-color: var(--md3-button-bg);
    color: var(--md3-button-on);
    border: none;

    @include button-overlays(var(#{$state-var}));
    @include button-focus-ring();
}

@mixin button-outlined($role: primary, $include-base: true) {
    @if $include-base { @include button-structure(); }

    $state-var: tokens.md3-var($role);

    --md3-button-bg: var(--md3-button-bg, transparent);
    --md3-button-on: var(--md3-button-on, var(#{tokens.md3-var(on-surface)}));
    --md3-button-outline-color: var(--md3-button-outline-color, var(#{tokens.md3-var(outline)}));
    @include button-shadow(none);

    background-color: transparent;
    color: var(--md3-button-on);
    border: 1px solid var(--md3-button-outline-color, var(#{tokens.md3-var(outline)}));

    @include button-overlays(var(#{$state-var}));
    @include button-focus-ring();
}

@mixin button-text($role: primary, $include-base: true) {
    @if $include-base { @include button-structure(); }

    $color-var: tokens.md3-var($role);

    --md3-button-bg: var(--md3-button-bg, transparent);
    --md3-button-on: var(--md3-button-on, var(#{$color-var}));
    --md3-button-outline-color: var(--md3-button-outline-color, transparent);
    @include button-shadow(none);

    background-color: transparent;
    color: var(--md3-button-on);
    border: none;
    padding-inline: var(--padding-sm);

    @include button-overlays(var(#{$color-var}));
    @include button-focus-ring();
}

@mixin button-icon($size: var(--icon-size-lg)) {
    min-inline-size: $size;
    min-block-size: $size;
    inline-size: $size;
    block-size: $size;
    padding: 0;
    border-radius: 50%;
    justify-content: center;

    & > :where(ui-icon, svg) {
        inline-size: 60%;
        block-size: 60%;
    }
}

@mixin button-base {
    @include button-structure();
}

//
@mixin button-interactions($transition: var(--transition-base, var(--duration-normal))) {
    @include animation.transition(all, $transition);
}

//
@mixin button-colors() {
    @include button-structure();
    @include colorize.text-color(0);
    @include colorize.solid-colorize("&");
}

//
@mixin button-base-variant() {
    // Reuse unified structure with alternate sizing tokens
    @include button-structure();
    @include layout.font-style("&");

    //
    @include button-interactions();
    @include button-colors();
}

//
@mixin toolbar-button {
    font-size: var(--font-size-sm);

    //
    @include layout.container-query("md") { span { display: none; } }
}
