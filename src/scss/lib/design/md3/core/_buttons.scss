@use "sass:map";

//
@use "../../../core/layout" as layout;

//
@use "../variables/text" as text;
@use "../variables/color" as color;
@use "../core/colorize" as colorize;
@use "../variables/motion" as motion;
@use "../variables/shadow" as shadow;
@use "../variables/utils" as utils;



// -----------------------------------------------------------------------------
// Shared base styles
// -----------------------------------------------------------------------------

@mixin button-structure() {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    place-items: center;
    place-content: center;
    gap: var(--button-gap, var(--gap-sm));
    padding-block: var(--button-padding-y, var(--padding-sm));
    padding-inline: var(--button-padding-x, var(--padding-lg));
    min-block-size: var(--button-min-height, 2.75rem);
    border-radius: var(--button-radius, var(--radius-full));
    cursor: pointer;
    transition:
        var(--transition-transform, transform var(--duration-fast) var(--ease-out)),
        var(--transition-colors, color var(--duration-normal) var(--ease-out), background-color var(--duration-normal) var(--ease-out)),
        var(--transition-opacity, opacity var(--duration-normal) var(--ease-out));

    //
    pointer-events: auto;
    margin: 0;
    border: none;
    outline: none;

    //
    position: relative;
    isolation: isolate;
    font-size: text.md3-type("label-large", size);

    //
    letter-spacing: 0.01em;
    text-decoration: none;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    user-select: none;

    //
    min-inline-size: 0px;
    block-size: fit-content;
    inline-size: fit-content;
    max-block-size: stretch;
    max-inline-size: stretch;
    flex-wrap: nowrap;

    //
    &:disabled {
        opacity: var(--state-opacity-disabled, 0.38);
        pointer-events: none;
    }

    //
    & > * { max-inline-size: stretch; }

    //
    & :where(span, a) {
        display: inline;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        flex-wrap: nowrap;
    }

    //
    &:is(input) {
        display: inline-block;
    }
}

//
@mixin button-overlays($fallback-color) {
    --md-button-state-color: var(--md-button-state-color, #{$fallback-color});
    position: relative;
    overflow: hidden;

    &::after,
    &::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        mix-blend-mode: normal;
    }

    &::after {
        opacity: 0;
        transition: opacity var(--duration-normal) var(--ease-out);
        background-color: color-mix(
            in oklch,
            var(--md-button-state-color, #{$fallback-color}) calc(var(--state-opacity-hover, 0.08) * 100%),
            transparent
        );
    }

    &::before {
        opacity: 0;
        transition: opacity var(--duration-fast) var(--ease-out);
        background-color: color-mix(
            in oklch,
            var(--md-button-state-color, #{$fallback-color}) calc(var(--state-opacity-press, 0.12) * 100%),
            transparent
        );
    }

    &:hover::after,
    &:focus-visible::after { opacity: 1; }
    &:active::before { opacity: 1; }
}

@mixin button-focus-ring() {
    &:focus-visible {
        outline: 2px solid color-mix(
            in oklch,
            var(--md-button-state-color, var(--md-primary)) calc(var(--state-opacity-focus, 0.12) * 100%),
            transparent
        );
        outline-offset: 3px;
    }
}

@mixin button-shadow($shadow) {
    --md-button-shadow: #{$shadow};
    box-shadow: var(--md-button-shadow, none);
}



// -----------------------------------------------------------------------------
// Variant mixins
// -----------------------------------------------------------------------------

@mixin button-filled($role: primary, $include-base: true) {
    @include colorize.solid-colorize("&");
    @if $include-base { @include button-structure(); }

    $bg-var: color.md3-var($role);
    $on-var: color.md3-var(color.md3-on($role));

    --md-button-bg: color-mix(in oklch, var(--surface-color, transparent) 90%, var(--on-surface-color, transparent));
    --md-button-on: var(--on-surface-color, currentColor);
    --md-button-outline-color: var(--border-color, transparent);

    background-color: var(--md-button-bg, var(--surface-color, transparent));
    color: var(--md-button-on, var(--on-surface-color, currentColor));
    border: none;

    @include button-shadow(none);
    @include button-overlays(var(#{$bg-var}));
    @include button-focus-ring();
}

//
@mixin button-elevated($role: primary, $include-base: true) {
    @include colorize.solid-colorize("&");
    @if $include-base { @include button-structure(); }

    $state-var: color.md3-var($role);

    --md-button-bg: color-mix(in oklch, var(--surface-color, transparent) 90%, var(--on-surface-color, transparent));
    --md-button-on: var(--on-surface-color, currentColor);
    --md-button-outline-color: var(--border-color, transparent);

    background-color: var(--md-button-bg, var(--surface-color, transparent));
    color: var(--md-button-on, var(--on-surface-color, currentColor));
    border: none;

    @include button-overlays(var(#{$state-var}));
    @include button-focus-ring();
    @include button-shadow(shadow.md3-elevation(2));
}

@mixin button-tonal($container-role: secondary-container, $state-role: secondary, $include-base: true) {
    @include colorize.solid-colorize("&");
    @if $include-base { @include button-structure(); }

    $container-var: color.md3-var($container-role);
    $on-var: color.md3-var(color.md3-on($container-role));
    $state-var: color.md3-var($state-role);

    --md-button-bg: color-mix(in oklch, var(--surface-color, transparent) 90%, var(--on-surface-color, transparent));
    --md-button-on: var(--on-surface-color, currentColor);
    --md-button-outline-color: var(--border-color, transparent);

    background-color: var(--md-button-bg, var(--surface-color, transparent));
    color: var(--md-button-on, var(--on-surface-color, currentColor));
    border: none;

    @include button-overlays(var(#{$state-var}));
    @include button-focus-ring();
    @include button-shadow(none);
}

@mixin button-outlined($role: primary, $include-base: true) {
    @include colorize.solid-colorize("&");
    @if $include-base { @include button-structure(); }

    $state-var: color.md3-var($role);

    --md-button-bg: color-mix(in oklch, var(--surface-color, transparent) 90%, var(--on-surface-color, transparent));
    --md-button-on: var(--on-surface-color, currentColor);
    --md-button-outline-color: var(--border-color, transparent);

    background-color: transparent;
    color: var(--md-button-on, var(--on-surface-color, currentColor));
    border: 1px solid var(--md-button-outline-color, var(#{color.md3-var(outline)}));

    @include button-shadow(none);
    @include button-overlays(var(#{$state-var}));
    @include button-focus-ring();
}

@mixin button-text($role: primary, $include-base: true) {
    @include colorize.solid-colorize("&");
    @if $include-base { @include button-structure(); }

    $color-var: color.md3-var($role);

    --md-button-bg: color-mix(in oklch, var(--surface-color, transparent) 90%, var(--on-surface-color, transparent));
    --md-button-on: var(--on-surface-color, currentColor);
    --md-button-outline-color: var(--border-color, transparent);

    background-color: transparent;
    color: var(--md-button-on, var(--on-surface-color, currentColor));
    border: none;
    padding-inline: var(--padding-sm);

    @include button-shadow(none);
    @include button-overlays(var(#{$color-var}));
    @include button-focus-ring();
}

@mixin button-icon($size: var(--icon-size-lg)) {
    min-inline-size: $size;
    min-block-size: $size;
    inline-size: $size;
    block-size: $size;
    padding: 0;
    border-radius: 50%;
    justify-content: center;

    & > :where(ui-icon, svg) {
        inline-size: 60%;
        block-size: 60%;
    }
}

@mixin button-base {
    @include button-structure();
    @include button-filled();
}

//
@mixin button-interactions($transition: var(--transition-base, var(--duration-normal))) {
    @include motion.transition(all, $transition);
}

//
@mixin button-colors() {
    @include button-structure();
    @include button-filled();
}

//
@mixin button-base-variant() {
    // Reuse unified structure with alternate sizing tokens
    @include button-structure();
    @include button-interactions();
    @include button-colors();
}

//
@mixin toolbar-button {
    font-size: var(--font-size-sm);

    //
    @include layout.container-query("md") { span { display: none; } }
}
