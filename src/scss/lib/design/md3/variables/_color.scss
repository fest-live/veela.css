@use "sass:list";
@use "sass:map";
@use "sass:math";
@use "sass:meta";
@use "sass:string";

//
@use "utils" as _;

//
// Light scheme
$md3-light-scheme: (
    primary: #6750a4,
    on-primary: #ffffff,
    primary-container: #eaddff,
    on-primary-container: #21005d,
    secondary: #625b71,
    on-secondary: #ffffff,
    secondary-container: #e8def8,
    on-secondary-container: #1d192b,
    tertiary: #7d5260,
    on-tertiary: #ffffff,
    tertiary-container: #ffd8e4,
    on-tertiary-container: #31111d,
    error: #b3261e,
    on-error: #ffffff,
    error-container: #f9dedc,
    on-error-container: #410e0b,
    surface: #fffbfe,
    on-surface: #1c1b1f,
    surface-tint: #6750a4,
    surface-variant: #e7e0ec,
    on-surface-variant: #49454f,
    outline: #79747e,
    outline-variant: #cac4d0,
    background: #fffbfe,
    on-background: #1c1b1f,
    inverse-surface: #313033,
    inverse-on-surface: #f4eff4,
    inverse-primary: #d0bcff,
    shadow: #000000,
    scrim: #000000,
    surface-dim: #ded8e1,
    surface-bright: #fef7ff,
    surface-container-lowest: #ffffff,
    surface-container-low: #f7f2fa,
    surface-container: #f3edf7,
    surface-container-high: #ede6f0,
    surface-container-highest: #e6e0e9,
    primary-fixed: #eaddff,
    primary-fixed-dim: #d0bcff,
    on-primary-fixed: #21005d,
    on-primary-fixed-variant: #4f378b,
    secondary-fixed: #e8def8,
    secondary-fixed-dim: #ccc2dc,
    on-secondary-fixed: #1d192b,
    on-secondary-fixed-variant: #4a4458,
    tertiary-fixed: #ffd8e4,
    tertiary-fixed-dim: #efb8c8,
    on-tertiary-fixed: #31111d,
    on-tertiary-fixed-variant: #633b48,
    neutral: #e6e1e5,
    neutral-variant: #e7e0ec,
);

//
// Dark scheme
$md3-dark-scheme: (
    primary: #d0bcff,
    on-primary: #381e72,
    primary-container: #4f378b,
    on-primary-container: #eaddff,
    secondary: #ccc2dc,
    on-secondary: #332d41,
    secondary-container: #4a4458,
    on-secondary-container: #e8def8,
    tertiary: #efb8c8,
    on-tertiary: #492532,
    tertiary-container: #633b48,
    on-tertiary-container: #ffd8e4,
    error: #f2b8b5,
    on-error: #601410,
    error-container: #8c1d18,
    on-error-container: #f9dedc,
    surface: #1c1b1f,
    on-surface: #e6e1e5,
    surface-tint: #d0bcff,
    surface-variant: #49454f,
    on-surface-variant: #cac4d0,
    outline: #938f99,
    outline-variant: #49454f,
    background: #1c1b1f,
    on-background: #e6e1e5,
    inverse-surface: #e6e1e5,
    inverse-on-surface: #313033,
    inverse-primary: #6750a4,
    shadow: #000000,
    scrim: #000000,
    surface-dim: #141218,
    surface-bright: #36343b,
    surface-container-lowest: #0f0d13,
    surface-container-low: #1d1b20,
    surface-container: #211f26,
    surface-container-high: #2b2930,
    surface-container-highest: #36343b,
    primary-fixed: #eaddff,
    primary-fixed-dim: #d0bcff,
    on-primary-fixed: #21005d,
    on-primary-fixed-variant: #4f378b,
    secondary-fixed: #e8def8,
    secondary-fixed-dim: #ccc2dc,
    on-secondary-fixed: #1d192b,
    on-secondary-fixed-variant: #4a4458,
    tertiary-fixed: #ffd8e4,
    tertiary-fixed-dim: #efb8c8,
    on-tertiary-fixed: #31111d,
    on-tertiary-fixed-variant: #633b48,
    neutral: #47454a,
    neutral-variant: #49454f,
);

//
// Color schemes
$md3-color-schemes: (
    light: $md3-light-scheme,
    dark: $md3-dark-scheme,
);

//
// Surface role map
$md3-surface-role-map: (
    primary: on-primary,
    primary-container: on-primary-container,
    primary-fixed: on-primary-fixed,
    primary-fixed-dim: on-primary-fixed,
    secondary: on-secondary,
    secondary-container: on-secondary-container,
    secondary-fixed: on-secondary-fixed,
    secondary-fixed-dim: on-secondary-fixed,
    tertiary: on-tertiary,
    tertiary-container: on-tertiary-container,
    tertiary-fixed: on-tertiary-fixed,
    tertiary-fixed-dim: on-tertiary-fixed,
    error: on-error,
    error-container: on-error-container,
    surface: on-surface,
    surface-dim: on-surface,
    surface-bright: on-surface,
    surface-variant: on-surface-variant,
    surface-container-lowest: on-surface,
    surface-container-low: on-surface,
    surface-container: on-surface,
    surface-container-high: on-surface,
    surface-container-highest: on-surface,
    background: on-background,
    inverse-surface: inverse-on-surface,
    outline: on-surface,
    outline-variant: on-surface,
    surface-tint: on-surface,
);


//
// State opacity
$md3-state-opacity: (
    hover: 0.08,
    focus: 0.12,
    focus-visible: 0.12,
    focus-ring: 0.22,
    press: 0.12,
    drag: 0.16,
    selected: 0.16,
    disabled: 0.38,
    icon: 0.54,
);

//
// State function
@function md3-state($state) {
    @return _.md3-fetch($md3-state-opacity, $state, "state");
}

//
// Color scheme functions
@function md3-color-scheme($mode: light) {
    @return _.md3-fetch($md3-color-schemes, $mode, "color mode");
}

//
// Color function
@function md3-color($role, $mode: light) {
    $scheme: md3-color-scheme($mode);
    @if $role == null {
        @return transparent;
    }
    @return _.md3-fetch($scheme, $role, "color role");
}

//
// Variable function
@function md3-var($role) {
    @return "--md3-#{$role}";
}

//
// Has color function
@function md3-has-color($role, $mode: null) {
    @if $mode == null {
        @return md3-has-color($role, light) or md3-has-color($role, dark);
    }

    $scheme: map.get($md3-color-schemes, $mode);
    @return $scheme != null and map.has-key($scheme, $role);
}

//
// On role function
@function md3-on($role) {
    @if map.has-key($md3-surface-role-map, $role) {
        @return map.get($md3-surface-role-map, $role);
    }

    $candidate: unquote("on-#{$role}");

    @if md3-has-color($candidate) {
        @return $candidate;
    }

    @if string.index($role, "on-") == 1 {
        @return $role;
    }

    @return "on-surface";
}

//
// Surface mixin
@mixin md3-surface($role: surface, $on-role: null, $elevation: null, $tint: null) {
    $bg-var: md3-var($role);
    $on-role-computed: if($on-role != null, $on-role, md3-on($role));
    background: var(#{$bg-var});
    background-color: var(#{$bg-var});
    color: var(#{md3-var($on-role-computed)});

    @if $tint != null {
        --surface-tint-color: var(#{md3-var($tint)});
    }

    @if $elevation != null {
        --md3-elevation-level: #{$elevation};
        box-shadow: var(--md3-elevation-#{$elevation}, #{md3-elevation($elevation)});
    }
}


//
// Export color vars mixin
@mixin md3-export-color-vars($mode: light) {
    $scheme: md3-color-scheme($mode);
    color-scheme: if($mode == dark, dark, light);

    @each $role, $value in $scheme {
        #{md3-var($role)}: #{$value};
    }

    --md3-shadow: #{map.get($scheme, shadow)};
    --md3-scrim: #{map.get($scheme, scrim)};

    --color-primary: var(--md3-primary);
    --color-secondary: var(--md3-secondary);
    --color-tertiary: var(--md3-tertiary);
    --color-accent: var(--md3-tertiary);
    --color-surface: var(--md3-surface);
    --color-surface-variant: var(--md3-surface-variant);
    --color-outline: var(--md3-outline);
    --color-outline-variant: var(--md3-outline-variant);
    --color-on-surface: var(--md3-on-surface);
    --color-on-background: var(--md3-on-background);
    --color-background: var(--md3-background);
    --color-inverse-surface: var(--md3-inverse-surface);
    --color-inverse-on-surface: var(--md3-inverse-on-surface);
    --surface-tint-color: var(--md3-surface-tint);
    --color-error: var(--md3-error);
    --color-danger: var(--color-error);
    --color-success: oklch(0.72 0.13 150 / 1);
    --color-warning: oklch(0.82 0.12 80 / 1);
    --color-info: oklch(0.7 0.1 220 / 1);
}


//
// Legacy variable aliases (SCSS level)
$color-primary: md3-color(primary);
$color-secondary: md3-color(secondary);
$color-accent: md3-color(tertiary);
$color-success: oklch(0.72 0.13 150 / 1);
$color-warning: oklch(0.82 0.12 80 / 1);
$color-danger: oklch(0.62 0.17 23 / 1);
$color-info: oklch(0.7 0.1 220 / 1);

$text-primary: md3-color(on-surface);
$text-secondary: color-mix(in oklch, md3-color(on-surface) 75%, md3-color(on-surface-variant) 25%);
$text-muted: color-mix(in oklch, md3-color(on-surface-variant) 70%, md3-color(surface) 30%);
$text-light: #ffffff;

$bg-primary: md3-color(background);
$bg-secondary: md3-color(surface-container-low);
$bg-tertiary: md3-color(surface-container);
$bg-overlay: color-mix(in oklch, md3-color(surface) 88%, transparent);

$border-light: color-mix(in oklch, md3-color(on-surface-variant) 14%, transparent);
$border-medium: color-mix(in oklch, md3-color(on-surface-variant) 24%, transparent);
$border-strong: md3-color(outline);


//
// Material role map
$material-role-map: (
    primary: "--md-sys-color-primary",
    on-primary: "--md-sys-color-on-primary",
    primary-container: "--md-sys-color-primary-container",
    on-primary-container: "--md-sys-color-on-primary-container",
    secondary: "--md-sys-color-secondary",
    on-secondary: "--md-sys-color-on-secondary",
    secondary-container: "--md-sys-color-secondary-container",
    on-secondary-container: "--md-sys-color-on-secondary-container",
    tertiary: "--md-sys-color-tertiary",
    on-tertiary: "--md-sys-color-on-tertiary",
    tertiary-container: "--md-sys-color-tertiary-container",
    on-tertiary-container: "--md-sys-color-on-tertiary-container",
    error: "--md-sys-color-error",
    on-error: "--md-sys-color-on-error",
    error-container: "--md-sys-color-error-container",
    on-error-container: "--md-sys-color-on-error-container",
    surface: "--md-sys-color-surface",
    on-surface: "--md-sys-color-on-surface",
    surface-variant: "--md-sys-color-surface-variant",
    on-surface-variant: "--md-sys-color-on-surface-variant",
    outline: "--md-sys-color-outline",
    outline-variant: "--md-sys-color-outline-variant",
    background: "--md-sys-color-background",
    on-background: "--md-sys-color-on-background",
    inverse-surface: "--md-sys-color-inverse-surface",
    inverse-on-surface: "--md-sys-color-inverse-on-surface",
    inverse-primary: "--md-sys-color-inverse-primary",
    surface-tint: "--md-sys-color-surface-tint",
);

//
// Material mode suffix
$material-mode-suffix: (
    light: "",
    dark: "-dark",
);


//
// Export state vars mixin
@mixin md3-export-state-vars() {
    --state-opacity-hover: #{md3-state(hover)};
    --state-opacity-focus: #{md3-state(focus)};
    --state-opacity-press: #{md3-state(press)};
    --state-opacity-drag: #{md3-state(drag)};
    --state-opacity-selected: #{md3-state(selected)};
    --state-opacity-disabled: #{md3-state(disabled)};
    --state-opacity-icon: #{md3-state(icon)};

    --surface-opacity-subtle: 0.02;
    --surface-opacity-muted: 0.04;
    --surface-opacity-default: 0.06;
    --surface-opacity-emphasis: 0.08;
    --surface-opacity-strong: 0.10;

    --contrast-opacity-subtle: 0.02;
    --contrast-opacity-muted: 0.04;
    --contrast-opacity-default: 0.06;
    --contrast-opacity-emphasis: 0.08;
    --contrast-opacity-strong: 0.10;

    --text-tint-primary: 0;
    --text-tint-secondary: 0.04;
    --text-tint-muted: 0.08;
    --text-tint-disabled: 0.1;//#{md3-state(disabled)};

    --border-opacity-subtle: 0.04;
    --border-opacity-default: 0.06;
    --border-opacity-emphasis: 0.08;
    --border-opacity-strong: 0.10;
    --border-opacity-dashed: 0.12;

    --outline-opacity: 0.4;
    --outline-tint: 0;

    --scrollbar-opacity: 0.4;
    --scrollbar-tint: 0.1;

    --interaction-tone-direction: 1;
    --hover-lift: calc(0.04 * var(--interaction-tone-direction, 1));
    --active-lift: calc(0.05 * var(--interaction-tone-direction, 1));
    --focus-lift: calc(0.06 * var(--interaction-tone-direction, 1));
    --selection-opacity: 0.1;
}

//
// Material color utilities theme mixin
@mixin material-color-utilities-theme($mode, $selector) {
    $suffix: map.get($material-mode-suffix, $mode);

    #{$selector} {
        @each $role, $source in $material-role-map {
            #{md3-var($role)}: var(#{$source}#{$suffix}, #{md3-color($role, $mode)});
        }
    }
}

//
// Material color backward adapter mixin
@mixin material-color-backward-adapter($selector: ":where(:root, :host, :scope, body, div, section)") {
    @layer md3.c2-adapter {
        #{$selector} {
            --primary: var(--md-sys-color-primary, var(--primary-fallback, #469));
            --secondary: var(--md-sys-color-secondary, var(--secondary-fallback, var(--primary)));
            --tertiary: var(--md-sys-color-tertiary, var(--tertiary-fallback, var(--secondary)));
            --trinary: var(--tertiary);
            --accent: var(--md-sys-color-tertiary, var(--accent-fallback, var(--tertiary)));
            --current: var(--primary, inherit);

            --color-primary: var(--current, var(--primary, inherit));
            --color-secondary: var(--secondary, inherit);
            --color-tertiary: var(--tertiary, inherit);

            --color-surface: var(--md-sys-color-surface, var(--surface-fallback));
            --color-surface-variant: var(--md-sys-color-surface-variant, var(--surface-variant-fallback, var(--surface-fallback)));
            --color-background: var(--md-sys-color-background, var(--surface-fallback));
            --color-on-surface: var(--md-sys-color-on-surface, var(--on-surface-fallback));
            --color-on-background: var(--md-sys-color-on-background, var(--on-surface-fallback));

            --color-outline: var(--md-sys-color-outline, var(--outline-fallback));
            --color-outline-variant: var(--md-sys-color-outline-variant, var(--outline-variant-fallback, var(--outline-fallback)));

            --inverse-surface: var(--md-sys-color-inverse-surface, var(--inverse-surface-fallback, var(--surface-fallback)));
            --inverse-on-surface: var(--md-sys-color-inverse-on-surface, var(--inverse-on-surface-fallback, var(--on-surface-fallback)));
            --inverse-primary: var(--md-sys-color-inverse-primary, var(--inverse-primary-fallback, var(--current)));
        }
    }
}

//
// Material color utilities remap mixin
@mixin material-color-utilities-remap($system-selector: ":where(:root, :host, :scope, body, div, section, html)") {
    @at-root {

        //
        @layer md3.tokens {
            #{$system-selector}:where([data-theme="light"], [data-scheme="light"], .theme-light) {
                @include md3-export-color-vars(light);
            }

            //
            #{$system-selector}:where([data-theme="dark"], [data-scheme="dark"], .theme-dark) {
                @include md3-export-color-vars(dark);
            }

            //
            #{$system-selector}:not([data-theme]):not([data-scheme]),
            #{$system-selector}:where([data-theme="auto"], [data-scheme="auto"]),
            #{$system-selector}:where([data-theme="system"], [data-scheme="system"])
            {
                @media (prefers-color-scheme: light) {
                    @include md3-export-color-vars(light);
                }
                @media (prefers-color-scheme: dark) {
                    @include md3-export-color-vars(dark);
                }
            }
        }

        //
        @layer md3.mcu {
            #{$system-selector}:not([data-scheme]):not([data-theme]),
            #{$system-selector}:where([data-scheme="auto"], [data-theme="auto"]),
            #{$system-selector}:where([data-scheme="system"], [data-theme="system"])
            {
                @media (prefers-color-scheme: light) {
                    @include material-color-utilities-theme(light, "&");
                }

                @media (prefers-color-scheme: dark){
                    @include material-color-utilities-theme(dark, "&");
                }
            }

            #{$system-selector}:where([data-theme="dark"], [data-scheme="dark"]) {
                @include material-color-utilities-theme(dark, "&");
            }

            #{$system-selector}:where([data-theme="light"], [data-scheme="light"]) {
                @include material-color-utilities-theme(light, "&");
            }
        }

    }
}
