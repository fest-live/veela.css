@use "veela-lib" as md3;

// Register core typed properties
@include md3.declare-props();

// =============================================================================
// MD3 THEME GENERATION (Simplified)
// Reduced property chains for better performance
// =============================================================================

// Core palette tokens - single source of truth
@mixin define-palette-tokens($suffix: "", $theme-type: 2) {
    // Primary palette (simplified chain)
    --md-c2-primary#{$suffix}: var(--current, #469);
    --md-c2-secondary#{$suffix}: var(--secondary, var(--md-c2-primary#{$suffix}));
    --md-c2-tertiary#{$suffix}: var(--tertiary, var(--md-c2-secondary#{$suffix}));
    --md-c2-error#{$suffix}: var(--error, oklch(0.62 0.17 23));
    --md-c2-neutral#{$suffix}: --c2-surface(0.2, var(--md-c2-primary#{$suffix}), #{$theme-type});

    // Shift values (computed once)
    --md-c2-surface-shift#{$suffix}: clamp(0, calc(var(--background-tone-shift, 0) + 0.16), 1);
    --md-c2-on-surface-shift#{$suffix}: clamp(0, calc(var(--color-tone-shift, 0) + 0.06), 1);
    --md-c2-surface-variant-shift#{$suffix}: clamp(0, calc(var(--background-tone-shift, 0) + 0.34), 1);
    --md-c2-outline-shift#{$suffix}: clamp(0, calc(var(--color-tone-shift, 0) + 0.28), 1);
    --md-c2-contrast-shift#{$suffix}: clamp(0, calc(0.88 - var(--background-tone-shift, 0) * 0.3), 1);
    --md-c2-inverse-primary-shift#{$suffix}: clamp(0, calc(0.7 - var(--background-tone-shift, 0) * 0.2), 1);
}

// Surface tokens derived from palette
@mixin define-surface-tokens($suffix: "", $theme-type: 2) {
    // Primary surfaces
    --md-sys-color-primary#{$suffix}: var(--md-c2-primary#{$suffix});
    --md-sys-color-on-primary#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-primary#{$suffix}), #{$theme-type});
    --md-sys-color-primary-container#{$suffix}: --c2-surface(0.74, var(--md-c2-primary#{$suffix}), #{$theme-type});
    --md-sys-color-on-primary-container#{$suffix}: --c2-on-surface(0.26, var(--md-c2-primary#{$suffix}), #{$theme-type});

    // Secondary surfaces
    --md-sys-color-secondary#{$suffix}: var(--md-c2-secondary#{$suffix});
    --md-sys-color-on-secondary#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-secondary#{$suffix}), #{$theme-type});
    --md-sys-color-secondary-container#{$suffix}: --c2-surface(0.68, var(--md-c2-secondary#{$suffix}), #{$theme-type});
    --md-sys-color-on-secondary-container#{$suffix}: --c2-on-surface(0.24, var(--md-c2-secondary#{$suffix}), #{$theme-type});

    // Tertiary surfaces
    --md-sys-color-tertiary#{$suffix}: var(--md-c2-tertiary#{$suffix});
    --md-sys-color-on-tertiary#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-tertiary#{$suffix}), #{$theme-type});
    --md-sys-color-tertiary-container#{$suffix}: --c2-surface(0.64, var(--md-c2-tertiary#{$suffix}), #{$theme-type});
    --md-sys-color-on-tertiary-container#{$suffix}: --c2-on-surface(0.22, var(--md-c2-tertiary#{$suffix}), #{$theme-type});

    // Error surfaces
    --md-sys-color-error#{$suffix}: var(--md-c2-error#{$suffix});
    --md-sys-color-on-error#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-error#{$suffix}), #{$theme-type});
    --md-sys-color-error-container#{$suffix}: --c2-surface(0.72, var(--md-c2-error#{$suffix}), #{$theme-type});
    --md-sys-color-on-error-container#{$suffix}: --c2-on-surface(0.24, var(--md-c2-error#{$suffix}), #{$theme-type});

    // Neutral surfaces
    --md-sys-color-surface#{$suffix}: --c2-surface(var(--md-c2-surface-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-on-surface#{$suffix}: --c2-on-surface(var(--md-c2-on-surface-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-surface-variant#{$suffix}: --c2-surface(var(--md-c2-surface-variant-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-on-surface-variant#{$suffix}: --c2-on-surface(clamp(0, calc(var(--md-c2-on-surface-shift#{$suffix}) + 0.14), 1), var(--md-c2-neutral#{$suffix}), #{$theme-type});

    // Outline
    --md-sys-color-outline#{$suffix}: color-mix(in oklch, --c2-on-surface(var(--md-c2-outline-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type}) 58%, transparent);
    --md-sys-color-outline-variant#{$suffix}: color-mix(
        in oklch,
        --c2-on-surface(clamp(0, calc(var(--md-c2-outline-shift#{$suffix}) + 0.1), 1), var(--md-c2-neutral#{$suffix}), #{$theme-type}) 34%,
        --c2-surface(var(--md-c2-surface-variant-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type}) 66%
    );

    // Background
    --md-sys-color-background#{$suffix}: --c2-surface(var(--background-tone-shift, 0), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-on-background#{$suffix}: --c2-on-surface(var(--color-tone-shift, 0), var(--md-c2-neutral#{$suffix}), #{$theme-type});

    // Inverse
    --md-sys-color-inverse-surface#{$suffix}: --c2-contrast(var(--md-c2-contrast-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-inverse-on-surface#{$suffix}: --c2-on-contrast(clamp(0, calc(var(--md-c2-on-surface-shift#{$suffix}) + 0.06), 1), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-inverse-primary#{$suffix}: --c2-contrast(var(--md-c2-inverse-primary-shift#{$suffix}), var(--md-c2-primary#{$suffix}), #{$theme-type});

    // Misc
    --md-sys-color-surface-tint#{$suffix}: var(--md-c2-primary#{$suffix});
    --md-sys-color-shadow#{$suffix}: color-mix(in oklch, var(--md-c2-neutral#{$suffix}) 24%, transparent);
    --md-sys-color-scrim#{$suffix}: color-mix(in oklch, var(--md-c2-neutral#{$suffix}) 70%, transparent);
}

// Combined theme mixin
@mixin make-md-theme($suffix: "", $theme-type: 2) {
    @include define-palette-tokens($suffix, $theme-type);
    @include define-surface-tokens($suffix, $theme-type);
}

// Adapter for MD3 color functions
@mixin material-color-c2-adapter-remap($selector: ":where(:root, :host, :scope, body, div, section)") {
    @at-root {
        @layer md3.c2-adapter {
            #{$selector} {
                @include make-md-theme("", 2);
                @include make-md-theme("-dark", 1);
                @include make-md-theme("-light", 0);
            }
        }
    }
}

// =============================================================================
// RUNTIME LAYER
// =============================================================================

@layer md3.runtime {
    // Root-level palette defaults (simplified)
    :where(:root, :scope) {
        // Core palette (single source - no fallback chains)
        --primary: #469;
        --secondary: oklch(from var(--current, #469) l calc(c * 0.88) calc(h + 120));
        --tertiary: oklch(from var(--current, #469) l calc(c * 0.84) calc(h + 240));
        --accent: var(--tertiary);
        --current: var(--primary);

        // Color scheme handling
        @media(prefers-color-scheme: dark) { color-scheme: dark; }
        @media(prefers-color-scheme: light) { color-scheme: light; }

        & { color-scheme: light; }
        &:is([data-scheme="dark"], [data-theme="dark"]) { color-scheme: dark only; }
        &:is([data-scheme="light"], [data-theme="light"]) { color-scheme: light only; }
        &:is([data-scheme="system"], [data-theme="system"], [data-scheme="auto"], [data-theme="auto"]) {
            color-scheme: light dark;
        }
    }

    // Color modifiers reset
    :where(:root, :host, :scope) :where(*) {
        --color-shade: 0;
        --color-tint: 0;
        --color-opacity: 0;
        --color-enable-blur: 0;
        --_color-shade: var(--color-shade, 0);
        --_color-tint: var(--color-tint, 0);
    }

    // Host defaults
    :host {
        --current: var(--primary, transparent);
        color-scheme: inherit;
    }

    // Export all design tokens
    :where(:root, :host, :scope) {
        @include material-color-c2-adapter-remap();
        @include md3.md3-export-scale-vars();
        @include md3.md3-export-density-vars();
        @include md3.md3-export-layout-vars();
        @include md3.md3-export-motion-vars();
        @include md3.md3-export-typography-vars();
        @include md3.md3-export-elevation-vars();
        @include md3.md3-export-state-vars();
    }
}
