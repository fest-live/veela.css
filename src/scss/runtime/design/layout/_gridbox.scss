@use "veela-lib" as *;

//
@layer ux-gridbox {

    //
    .ui-gridlayout {
        @include compute_orient_grid_layout();

        //
        & {
            --c-gap: clamp(min(1rem, 8cqmin), min(calc(8cqmin / min(var(--layout-c, 4), var(--layout-r, 8))), calc(6cqmax / max(var(--layout-c, 4), var(--layout-r, 8)))), min(4rem, 16cqmin));
            --r-gap: clamp(min(1rem, 8cqmin), min(calc(8cqmin / min(var(--layout-c, 4), var(--layout-r, 8))), calc(6cqmax / max(var(--layout-c, 4), var(--layout-r, 8)))), min(4rem, 16cqmin));
        }

        //
        & {
            //display: block flow;
            display: block grid;
            position: relative;

            //
            container-name: u2-grid;
            container-type: normal;
            //container-type: size;
            contain: none;

            //
            zoom: 1;
            direction: ltr;

            //
            pointer-events: none;
            background-color: transparent;

            //
            inline-size: stretch;
            block-size: stretch;
            padding: 0px;
            overflow: visible;

            //
            max-inline-size: stretch;
            max-block-size: stretch;

            //
            grid-template-columns: repeat(round(nearest, var(--cs-layout-c, 4), 1), minmax(0px, 1fr));
            grid-template-rows: repeat(round(nearest, var(--cs-layout-r, 8), 1), minmax(0px, 1fr));
            //grid-column-gap: var(--c-gap, 1rem);
            //grid-row-gap: var(--r-gap, 1rem);

            //
            justify-content: safe start !important;
            align-content: safe start !important;
            justify-items: safe start !important;
            align-items: safe start !important;

            //
            grid-row: 1 / -1;
            grid-column: 1 / -1;
        }

        //
        & > :where(*) {
            @include compute_grid_item_cell();

            // calculate visible size
            & { --item-size: min((100cqmin / min(calc(var(--layout-c, 4) / var(--ox-c-span, 1)), calc(var(--layout-r, 8) / var(--ox-r-span, 1)))) - 0.5 * min(var(--c-gap, 1rem), var(--r-gap, 1rem)), 6rem); }
            & :where(*) {--drag-x: 0; --drag-y: 0; }

            // dragging coordinate
            & {
                --drag-x: 0; --cs-drag-x: 0px;
                --drag-y: 0; --cs-drag-y: 0px;
            }

            //
            &[data-dragging] {
                --cs-drag-x: calc(var(--drag-x, 0) * 1px);
                --cs-drag-y: calc(var(--drag-y, 0) * 1px);
            }

            //
            &:active, &:has(:active), *:active {
                will-change: transform;
            }

            //
            & {
                position: relative !important;
                z-index: 1;
                transform-origin: 0% 0%;
                transform:
                    translate3d(
                        round(nearest, calc(var(--cs-drag-x, 0px) + var(--cs-transition-c, 0px)), calc(1px / var(--pixel-ratio, 1))),
                        round(nearest, calc(var(--cs-drag-y, 0px) + var(--cs-transition-r, 0px)), calc(1px / var(--pixel-ratio, 1))),
                        0px)
                    scale3d(var(--scale, 1), var(--scale, 1), var(--scale, 1))
                    translate3d(
                        round(nearest, calc(var(--translate-x, 0px) - 50%), calc(1px / var(--pixel-ratio, 1))),
                        round(nearest, calc(var(--translate-y, 0px) - 50%), calc(1px / var(--pixel-ratio, 1))),
                        0px) !important;
                translate: 0px 0px 0px;

                //
                inset: auto;

                //
                inset-block-start: calc(var(--cs-sw-unit-y, 1px) * 0.5);
                inset-inline-start: calc(var(--cs-sw-unit-x, 1px) * 0.5);

                //
                grid-column: calc(1 + round(nearest, var(--cs-grid-c, 0), 1));
                grid-row: calc(1 + round(nearest, var(--cs-grid-r, 0), 1));

                //
                zoom: 1;
                place-self: start;

                //
                min-inline-size: 1px;
                min-block-size: 1px;

                //
                inline-size: stretch;
                block-size: stretch;

                //
                max-inline-size: var(--item-size, 1px);
                max-block-size: var(--item-size, 1px);

                //
                pointer-events: none;
                touch-action: none;
                user-select: none;
                -webkit-user-drag: none;
                -moz-user-drag: none;

                //
                overflow: visible;
                isolation: isolate;
            }

            //
            & {
                --drag-distance: clamp(0, hypot(var(--dir-x, 0), var(--dir-y, 0)), 6);
                --drag-duration: clamp(96ms, calc(var(--drag-distance, 0) * 110ms + 70ms), 360ms);
                transition-behavior: allow-discrete;
                transition-property: transform;
                transition-duration: var(--drag-duration);
                transition-timing-function: cubic-bezier(0.22, 0.8, 0.3, 1);
                transition-delay: 0ms;
            }

            @media (prefers-reduced-motion: reduce) {
                & {
                    transition-duration: 0ms;
                    transition-timing-function: linear;
                }
            }

            // if interpolation keywords supported
            @supports (min-inline-size: max(1px, fit-content)) {
                min-inline-size: max(1px, fit-content);
                min-block-size: max(1px, fit-content);
            }

            //
            & > :where(*) {
                inline-size: 100%;
                block-size: 100%;
            }
        }

        //
        &.sd-grid--labels,
        &[data-layer="labels"] {
            pointer-events: none !important;
            isolation: isolate;
            mix-blend-mode: normal;

            //
            & > :where(*) {
                pointer-events: none;
            }

            //
            & > :where(.ui-ws-item-label) {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                gap: clamp(0.1rem, 0.35cqmin, 0.35rem);
                inline-size: 100%;
                block-size: stretch;
                padding-block-start: clamp(0.25rem, 0.65cqmin, 0.65rem);
                color: color-mix(in oklch, var(--on-surface-color) 78%, transparent 22%);
                font-size: clamp(0.65rem, 1.35cqmin, 1rem);
                font-weight: 500;
                text-align: center;
                text-wrap: balance;
                letter-spacing: 0.015em;
                text-shadow:
                    0 1px 2px color-mix(in oklch, var(--surface-color) 35%, transparent),
                    0 0 0.35rem color-mix(in oklch, var(--surface-color) 15%, transparent);
                translate: 0 calc(clamp(0.25rem, 0.65cqmin, 0.65rem) + var(--cs-sw-unit-y, 0px));
                filter: drop-shadow(0 0 0.2rem color-mix(in oklch, var(--surface-color) 25%, transparent));

                //
                span {
                    pointer-events: none;
                    user-select: none;
                    max-inline-size: min(8ch, 100%);
                    opacity: clamp(0.75, 0.9, 1);
                }
            }
        }
    }
}
