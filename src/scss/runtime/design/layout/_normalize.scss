@use "veela-lib" as *;

@layer ux-normalize {

    /* -------------------------------------------------------------------------- */
    /*                                  Variables                                 */
    /* -------------------------------------------------------------------------- */
    :root {
        /* Core tokens */
        --color-bg: #{md-light-dark("bg")};
        --color-bg-secondary: #{md-light-dark("bg-secondary")};
        --color-text: #{md-light-dark("text")};
        --color-text-secondary: #{md-light-dark("text-secondary")};
        --color-link: #{md-light-dark("link")};
        --color-accent: #{md-light-dark("accent")};
        --color-secondary: #{md-light-dark("secondary")};
        --color-secondary-accent: #{md-light-dark("secondary-accent")};
        --color-shadow: #{md-light-dark("shadow")};
        --color-border: #{md-light-dark("border")};
        --color-table: #{md-light-dark("table")};
        --color-scrollbar: #{md-light-dark("scrollbar")};

        /* Config tokens */
        --font-family: #{md-config("font", "body")};
        --font-family-mono: #{md-config("font", "mono")};
        --line-height: #{md-config("layout", "line-height")};

        --active-brightness: #{md-config("effects", "active-brightness")};
        --hover-brightness: #{md-config("effects", "hover-brightness")};

        --width-card: #{md-config("layout", "widths", "card")};
        --width-card-medium: #{md-config("layout", "widths", "card-medium")};
        --width-card-wide: #{md-config("layout", "widths", "card-wide")};
        --width-content: #{md-config("layout", "widths", "content")};

        --box-shadow: #{md-config("shape", "box-shadow")};
        --border-radius: #{md-config("shape", "border-radius")};

        --scrollbar-size: #{md-config("scrollbar", "size")};

        /* Syntax Highlighting (GitHub Light/Dark inspired) */
        --fgColor-default: light-dark(#1f2328, #f0f6fc);
        --fgColor-muted: light-dark(#656d76, #9198a1);
        --fgColor-accent: light-dark(#0969da, #4493f8);
        --fgColor-success: light-dark(#1a7f37, #3fb950);
        --fgColor-attention: light-dark(#9a6700, #d29922);
        --fgColor-danger: light-dark(#d1242f, #f85149);
        --fgColor-done: light-dark(#8250df, #ab7df8);

        --bgColor-default: light-dark(#ffffff, #0d1117);
        --bgColor-muted: light-dark(#f6f8fa, #151b23);
        --borderColor-default: light-dark(#d0d7de, #30363d);
        --borderColor-muted: light-dark(#d0d7de, #30363d);

        interpolate-size: allow-keywords;
    }

    @keyframes bottom-to-top {
        0% { opacity: 0; transform: translateY(10%); }
        100% { opacity: 1; transform: translateY(0); }
    }

    @layer ux-agate;

    @media screen {

        /* -------------------------------------------------------------------------- */
        /*                                    Base                                    */
        /* -------------------------------------------------------------------------- */

        :where(:root, html) {
            color-scheme: light dark;
            scroll-behavior: smooth;
            tab-size: 4;
            -webkit-text-size-adjust: none; /* Prevent font scaling in landscape on mobile */
            text-size-adjust: none;

            @media (prefers-reduced-motion: reduce) {
                scroll-behavior: auto;
            }

            &, :where(body, button, input, select, textarea) {
                font-family: var(--font-family);
            }
        }

        :where(body) {
            margin: 0;
            padding: 0;
            min-block-size: 100dvb;

            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: var(--line-height);

            /* Improve text rendering */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;

            @include HQRendering();
        }

        /* -------------------------------------------------------------------------- */
        /*                               Global Defaults                              */
        /* -------------------------------------------------------------------------- */

        :where(:host, :scope, :root) {

            :where(*), :where(*::before), :where(*::after) {
                box-sizing: border-box;
                border-width: 0;
                border-style: solid;
                border-color: var(--color-border);
                word-wrap: break-word;
            }

            :where(*), &::slotted(*) {
                /* Interaction defaults */
                -webkit-tap-highlight-color: transparent;
            }

            /* Media defaults */
            :where(img, video, canvas, svg, picture) {
                display: block;
                max-inline-size: 100%;
                block-size: auto;
                shape-margin: 0.75rem;
            }

            :where(img, video) {
                object-fit: cover;
            }

            :where(picture) { display: contents; }

            /* Typography defaults */
            :where(h1, h2, h3, h4, h5, h6) {
                font-weight: bold;
                text-wrap: balance;
                margin-block: 0.5em;
            }

            :where(p) {
                text-wrap: pretty;
                margin-block: 1em;
            }

            :where(a) {
                color: inherit;
                text-decoration: inherit;
                text-underline-offset: 0.2em;
            }

            /* Form defaults */
            :where(input, button, textarea, select) {
                font: inherit;
                color: inherit;
                letter-spacing: inherit;
            }

            /* Optimization */
            :where(img, video, audio, picture, canvas, h1, h2, h3, h4, h5, h6, p, form, label, button) {
                content-visibility: auto;
            }

            :where(div, span, a, h1, h2, h3, h4, h5, h6, p, label, form):empty:not([class]) {
                content-visibility: hidden;
            }

            /* Hidden Elements */
            [data-hidden], :where(head, script, link, style, meta, [hidden]) {
                display: none !important;
            }

            [aria-hidden="true"] {
                visibility: collapse;
                pointer-events: none;
                touch-action: none;
                user-select: none;
                content-visibility: auto;
                opacity: 0;
            }

            [data-dragging] {
                will-change: transform;
                cursor: grabbing;
            }

            /**:active, *:has(*:active) {
                will-change: transform, contents;
            }*/

            /* Reduced Motion */
            @media (prefers-reduced-motion: reduce) {
                :where(*, ::after, ::before) {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                    scroll-behavior: auto !important;
                }
            }

            /* Scrollbars */
            :where(*) {
                scrollbar-width: thin;
                scrollbar-color: var(--color-scrollbar) transparent;

                &::-webkit-scrollbar {
                    inline-size: var(--scrollbar-size);
                    block-size: var(--scrollbar-size);
                }

                &::-webkit-scrollbar-track { background: transparent; }
                &::-webkit-scrollbar-thumb {
                    background-color: var(--color-scrollbar);
                    border-radius: var(--border-radius);
                }
            }
        }

        /* -------------------------------------------------------------------------- */
        /*                                   Layout                                   */
        /* -------------------------------------------------------------------------- */

        :where(footer, header, main) {
            margin-inline: auto;
            max-inline-size: var(--width-content);
            padding: 2rem 1rem;
        }

        :where(section) {
            display: flex;
            flex-wrap: wrap;
            justify-content: var(--justify-important, center);
            gap: 1rem;

            :where(aside) {
                border: 1px solid var(--color-bg-secondary);
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                padding: 1.25rem;
                inline-size: var(--width-card);
                flex: 1 1 var(--width-card);

                &:hover {
                    box-shadow: var(--box-shadow-hover, var(--box-shadow));
                }
            }
        }

        /* -------------------------------------------------------------------------- */
        /*                                 Components                                 */
        /* -------------------------------------------------------------------------- */

        /* Header & Nav */
        :where(header) {
            text-align: center;
        }

        :where(nav) {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-block-end: 3rem;

            ul {
                display: flex;
                list-style: none;
                padding: 0;
                gap: 1rem;
                margin: 0;

                li { position: relative; }
            }

            a {
                font-weight: bold;
                color: var(--color-link);
                text-decoration: none;

                &:hover { text-decoration: underline; }
            }
        }

        /* Code blocks */
        :where(pre) {
            background-color: var(--bgColor-muted);
            border-radius: var(--border-radius);
            border: 1px solid var(--borderColor-muted);
            padding: 1rem;
            overflow: auto;
            font-family: var(--font-family-mono);
            max-inline-size: 100%;

            code {
                background: transparent;
                padding: 0;
                border-radius: 0;
            }
        }

        :where(code, samp, kbd) {
            font-family: var(--font-family-mono);
            background-color: var(--bgColor-muted);
            border-radius: 0.3em;
            padding: 0.2em 0.4em;
            font-size: 85%;
        }

        /* Blockquote */
        :where(blockquote) {
            margin-inline: 1rem;
            padding-inline: 1rem;
            border-inline-start: 0.25rem solid var(--color-secondary);
            color: var(--color-text-secondary);
        }

        /* Tables */
        :where(table) {
            display: block;
            overflow-x: auto;
            border-collapse: collapse;
            border-spacing: 0;
            inline-size: max-content;
            max-inline-size: 100%;
            margin-block: 1rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);

            :where(th, td) {
                padding: 0.5rem 1rem;
                border-block-end: 1px solid var(--color-border);
                text-align: start;
            }

            :where(th) {
                background-color: var(--color-table);
                color: var(--color-text);
                font-weight: bold;
            }

            :where(tr:last-child td) {
                border-block-end: none;
            }

            :where(tr:nth-child(even)) {
                background-color: var(--color-bg-secondary);
            }
        }

        /* Links & Buttons */
        :where(a) {
            color: var(--color-link);

            &:hover { filter: brightness(var(--hover-brightness)); }
            &:active { filter: brightness(var(--active-brightness)); }
        }

        :where(button, input[type="submit"], input[type="button"]) {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-link);
            color: #ffffff; /* Force white text on primary buttons */
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: filter 0.2s ease, transform 0.1s ease;

            &:hover {
                filter: brightness(var(--hover-brightness));
            }

            &:active {
                filter: brightness(var(--active-brightness));
                transform: translateY(1px);
            }

            &:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                filter: none;
                background-color: var(--color-secondary);
            }
        }

        /* Forms */
        :where(input:not([type="submit"]):not([type="button"]), select, textarea) {
            display: block;
            inline-size: 100%;
            padding: 0.5rem;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            color: var(--color-text);
            /*margin-block-end: 1rem;*/

            &:focus-visible {
                outline: 2px solid var(--color-link);
                outline-offset: -1px;
            }

            &::placeholder {
                color: var(--color-text-secondary);
                opacity: 0.7;
            }

            &:disabled {
                background-color: var(--color-bg-secondary);
                cursor: not-allowed;
            }
        }

        :where(label) {
            display: block;
            font-weight: 600;
            margin-block-end: 0.25rem;
        }

        /* Dialog */
        :where(dialog) {
            margin: auto;
            padding: 1rem;
            background: var(--color-bg);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-inline-size: min(90vw, 600px);
            max-block-size: 85vh;

            &::backdrop {
                background-color: rgb(0 0 0 / 0.5);
                backdrop-filter: blur(2px);
            }

            &[open] {
                animation: bottom-to-top 0.25s ease-out;
            }
        }

        /* -------------------------------------------------------------------------- */
        /*                                   Visuals                                  */
        /* -------------------------------------------------------------------------- */

        :where(canvas):is([is="ui-canvas"]) {
            position: fixed;
            inset: 0;
            inline-size: 100%;
            block-size: 100%;
            pointer-events: none;
            z-index: 0;
            image-rendering: optimizeQuality;
        }
    }

    /* Scheme Overrides */
    [data-scheme="dark"], [data-theme="dark"] { color-scheme: dark only; }
    [data-scheme="light"], [data-theme="light"] { color-scheme: light only; }
    [data-scheme="system"], [data-theme="system"] { color-scheme: light dark; }
}
