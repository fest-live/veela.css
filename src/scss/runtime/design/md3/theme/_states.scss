@use "veela-lib" as *;
@use "sass:list";
@use "sass:meta";


@function veela-state-shade($base, $delta: null) {
    @if $delta == null or $delta == 0 {
        @return $base;
    }

    @if meta.type-of($delta) == number {
        @return calc(#{$base} + #{$delta});
    }

    @return $delta;
}

@function veela-selector-list($selectors) {
    @if meta.type-of($selectors) == string {
        @return $selectors;
    }

    $result: "";

    @if meta.type-of($selectors) == list {
        @for $i from 1 through list.length($selectors) {
            $separator: if($i > 1, ", ", "");
            $result: #{$result}#{$separator}#{list.nth($selectors, $i)};
        }

        @return $result;
    }

    @return $selectors;
}

@mixin veela-interactive(
    $base,
    $hover: null,
    $focus: null,
    $active: null,
    $hover-selectors: (":hover"),
    $focus-selectors: (":focus", ":focus-visible"),
    $active-selectors: (":active"),
    $disabled-shade: null,
    $disabled-opacity: null,
    $disabled-selectors: (":disabled"),
    $outline-size: 2px,
    $outline-offset: 2px,
    $outline-alpha: var(--outline-opacity),
    $outline-enabled: true
) {
    @if $hover != null {
        &:where(#{veela-selector-list($hover-selectors)}):not(:disabled) {
            --color-shade: veela-state-shade($base, $hover);
        }
    }

    @if $focus != null {
        &:where(#{veela-selector-list($focus-selectors)}):not(:disabled) {
            --color-shade: veela-state-shade($base, $focus);

            @if $outline-enabled {
                outline: $outline-size solid oklch(from var(--current) l c h / #{$outline-alpha});
                outline-offset: $outline-offset;
            }
        }
    }

    @if $active != null {
        &:where(#{veela-selector-list($active-selectors)}):not(:disabled) {
            --color-shade: veela-state-shade($base, $active);
        }
    }

    @if $disabled-shade != null or $disabled-opacity != null {
        &:where(#{veela-selector-list($disabled-selectors)}) {
            @if $disabled-shade != null {
                --color-shade: veela-state-shade($base, $disabled-shade);
            }

            @if $disabled-opacity != null {
                opacity: $disabled-opacity;
            }
        }
    }
}

@mixin veela-select-surface() {
    background: var(--surface-color);
    border-color: var(--border-color);
    color: var(--on-surface-color);
    accent-color: currentColor;
    caret-color: currentColor;
    text-decoration-color: currentColor;
    text-emphasis-color: currentColor;
    scrollbar-color: var(--scrollbar-color) transparent;
    -webkit-text-fill-color: currentColor;
}

//
@layer ux-states {
    // =============================================================================
    // BUTTONS
    // =============================================================================

    :where(button) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-default);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.04,
            $focus: 0.06,
            $active: 0.08,
            $disabled-shade: var(--surface-opacity-subtle),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible")
        );
    }

    // =============================================================================
    // CHECKBOX & RADIO INPUTS
    // =============================================================================

    :where(input:is([type="checkbox"], [type="radio"])) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.04,
            $focus: 0.06,
            $active: 0.08,
            $disabled-shade: var(--surface-opacity-subtle),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible")
        );

        &:checked {
            //--current: var(--color-primary);
            --ux-state-base: var(--surface-opacity-emphasis);
            @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        }
    }

    // =============================================================================
    // TEXT INPUTS (text, number, email, password, search, tel, url, date, time, datetime-local, month, week)
    // =============================================================================

    :where(input:is([type="text"], [type="number"], [type="email"], [type="password"], [type="search"], [type="tel"], [type="url"], [type="date"], [type="time"], [type="datetime-local"], [type="month"], [type="week"])) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.03,
            $focus: 0.06,
            $active: 0.05,
            $disabled-shade: var(--ux-state-base),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible", ":focus-within")
        );

        &:invalid:not(:disabled) {
            --current: var(--color-error, var(--color-danger));
        }

        &:placeholder-shown {
            --color-tint: var(--text-tint-muted);
        }

        &::placeholder {
            color: oklch(from var(--current) l c h / calc(var(--text-tint-muted) + 0.1));
            opacity: 0.7;
        }
    }

    // =============================================================================
    // TEXTAREA
    // =============================================================================

    :where(textarea) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.03,
            $focus: 0.06,
            $active: 0.05,
            $disabled-shade: var(--ux-state-base),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible", ":focus-within")
        );

        &:invalid:not(:disabled) {
            --current: var(--color-error, var(--color-danger));
        }

        &:placeholder-shown {
            --color-tint: var(--text-tint-muted);
        }

        &::placeholder {
            color: oklch(from var(--current) l c h / calc(var(--text-tint-muted) + 0.1));
            opacity: 0.7;
        }
    }

    // =============================================================================
    // SELECT ELEMENT
    // =============================================================================

    :where(select) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.03,
            $focus: 0.06,
            $active: 0.05,
            $disabled-shade: var(--ux-state-base),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible")
        );

        &:invalid:not(:disabled) {
            --current: var(--color-error, var(--color-danger));
        }

        &::picker(select),
        & :where(option) {
            @include veela-select-surface();
        }
    }

    // =============================================================================
    // RANGE INPUT
    // =============================================================================

    :where(input[type="range"]) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        --ux-thumb-base: var(--surface-opacity-emphasis);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.03,
            $focus: 0.06,
            $active: 0.05,
            $disabled-opacity: 0.6
        );

        &::-webkit-slider-thumb,
        &::-moz-range-thumb {
            //--current: var(--color-primary);
            @include solid-colorize("&", ("shade": var(--ux-thumb-base), "tint": 0.0));
        }

        &:where(:hover, :focus, :focus-visible, :active):not(:disabled) {
            &::-webkit-slider-thumb,
            &::-moz-range-thumb {
                --color-shade: veela-state-shade(var(--ux-thumb-base), 0.05);
            }
        }

        &:disabled {
            &::-webkit-slider-thumb,
            &::-moz-range-thumb {
                --color-shade: var(--ux-thumb-base);
            }
        }
    }

    // =============================================================================
    // FILE INPUT
    // =============================================================================

    :where(input[type="file"]) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.03,
            $focus: 0.06,
            $active: 0.05,
            $disabled-shade: var(--ux-state-base),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible")
        );
    }

    // =============================================================================
    // COLOR INPUT
    // =============================================================================

    :where(input[type="color"]) {
        //--current: var(--color-primary);
        --ux-state-base: var(--surface-opacity-subtle);
        @include solid-colorize("&", ("shade": var(--ux-state-base), "tint": 0.0));
        @include veela-interactive(
            var(--ux-state-base),
            $hover: 0.03,
            $focus: 0.06,
            $active: 0.05,
            $disabled-shade: var(--ux-state-base),
            $disabled-opacity: 0.6,
            $focus-selectors: (":focus", ":focus-visible")
        );
    }

    :where(button, input, textarea, select):disabled {
        cursor: not-allowed;
    }

    // =============================================================================
    // PROGRESS ELEMENT
    // =============================================================================

    :where(progress) {
        //--current: var(--color-primary);
        @include solid-colorize("&", ("shade": var(--surface-opacity-subtle), "tint": 0.0));

        //
        &::-webkit-progress-bar {
            @include solid-colorize("&", ("shade": var(--surface-opacity-subtle), "tint": 0.0));
        }

        //
        &::-webkit-progress-value {
            @include solid-colorize("&", ("shade": var(--surface-opacity-emphasis), "tint": 0.0));
        }

        //
        &::-moz-progress-bar {
            @include solid-colorize("&", ("shade": var(--surface-opacity-emphasis), "tint": 0.0));
        }
    }

    // =============================================================================
    // METER ELEMENT
    // =============================================================================

    :where(meter) {
        //--current: var(--color-primary);
        @include solid-colorize("&", ("shade": var(--surface-opacity-subtle), "tint": 0.0));

        //
        &::-webkit-meter-bar {
            @include solid-colorize("&", ("shade": var(--surface-opacity-subtle), "tint": 0.0));
        }

        //
        &::-webkit-meter-optimum-value {
            --current: var(--color-success);
            @include solid-colorize("&", ("shade": var(--surface-opacity-emphasis), "tint": 0.0));
        }

        //
        &::-webkit-meter-suboptimum-value {
            --current: var(--color-warning);
            @include solid-colorize("&", ("shade": var(--surface-opacity-emphasis), "tint": 0.0));
        }

        //
        &::-webkit-meter-even-less-good-value {
            --current: var(--color-danger);
            @include solid-colorize("&", ("shade": var(--surface-opacity-emphasis), "tint": 0.0));
        }
    }

    // =============================================================================
    // INPUT STATE VARIANTS
    // =============================================================================

    :where(input, textarea, select) {
        // Success state
        &.state-success,
        &.is-success,
        &[data-state="success"] {
            --current: var(--color-success);
            @include validation-success;
        }

        // Warning state
        &.state-warning,
        &.is-warning,
        &[data-state="warning"] {
            --current: var(--color-warning);
            @include validation-warning;
        }

        // Error state
        &.state-error,
        &.is-error,
        &.state-invalid,
        &.is-invalid,
        &[data-state="error"],
        &[data-state="invalid"] {
            --current: var(--color-error, var(--color-danger));
            @include validation-error;
        }

        // Valid state
        &.state-valid,
        &.is-valid,
        &[data-state="valid"] {
            --current: var(--color-success);
            @include validation-success;
        }
    }
}