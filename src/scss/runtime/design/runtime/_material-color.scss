@use "veela-lib" as md3;
@use "sass:string";


/* */
//
@property --current { syntax: "<color>"; initial-value: #469; inherits: true; }
@property --primary { syntax: "<color>"; initial-value: #469; inherits: true; }
@property --secondary { syntax: "<color>"; initial-value: #469; inherits: true; }
@property --trinary { syntax: "<color>"; initial-value: #469; inherits: true; }

//
@property --accent { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --error { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --neutral { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --surface { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --on-surface { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --surface-color { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --on-surface-color { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --outline { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --contrast { syntax: "<color>"; initial-value: #0000; inherits: true; };
@property --current-is-light { syntax: "<number>"; initial-value: 1; inherits: true; };

/* */
@property --background-tone-shift { syntax: "<number>"; initial-value: 0.0; inherits: true; };
@property --color-tone-shift { syntax: "<number>"; initial-value: 0.0; inherits: true; };
@property --icon-tone-shift { syntax: "<number>"; initial-value: 0.0; inherits: true; };
@property --accent-tone-shift { syntax: "<number>"; initial-value: 0.0; inherits: true; };
@property --scrollbar-tone-shift { syntax: "<number>"; initial-value: 0.0; inherits: true; };

//
@property --c2h-ct { syntax: "<number>"; initial-value: 0; inherits: true; };



//
@mixin make-func($selector) {
    @if (string.slice($selector, 1, 1) == "@") {
        @#{string.slice($selector, 2)} { @content; }
    } @else {
        @#{$selector} { @content; }
    }
}

//
@function if-cond($c, $a, $b) { @return #{"if(\
    #{$c}: #{$a};\
     else: #{$b};\
)"}; }


//
@include make-func("@function --c2h-triple-mix(\
--c2h-a <color>, \
--c2h-b <color>, \
--c2h-c <color>, \
--c2h-factor <number> \
)") {
    --c2h-t : clamp(0, var(--c2h-factor, 0), 1);
    --c2h-ct: clamp(0, round(nearest, var(--c2h-t), 1), 1);
    --c2h-dz: clamp(0, calc(var(--c2h-t) * 2 - 1), 1);
    --c2h-lz: clamp(0, calc(var(--c2h-t) * 2 - 0), 1);

    /* */
    --c2h-lc: color-mix(in oklch, var(--c2h-a) calc((1 - var(--c2h-u)) * 100%), var(--c2h-b) calc(var(--c2h-u) * 100%));
    --c2h-dc: color-mix(in oklch, var(--c2h-b) calc((1 - var(--c2h-u)) * 100%), var(--c2h-c) calc(var(--c2h-u) * 100%));

    /* */
    --c2h-u: calc(
        var(--c2h-ct) * var(--c2h-dz) +
        (1 - var(--c2h-ct)) * var(--c2h-lz)
    );
    result: color-mix(in oklch,
        var(--c2h-lc) calc((1 - var(--c2h-ct)) * 100%),
        var(--c2h-dc) calc(var(--c2h-ct) * 100%)
    );
}

//
@include make-func("@function --c2h-re-shading(\
--c2h-color <color>, \
--c2h-factor <number>: 0, \
--c2h-theme-type <number>: 2 \
)") {
    /* chromatic neutralize (unused) ir chromatic, or make very chromatic if too gray */
    --c2h-chromatic-inverse-ls: oklch(from var(--c2h-color) l calc(1 - c) h);
    --c2h-chromatic-inverse-ds: oklch(from var(--c2h-color) l calc(1 - c) h);

    /* from light source colors (l > 0.5, not very chromatic) */
    --c2h-chromatic-extract-ls: oklch(from var(--c2h-color) l calc(c * 0.5) h);  /* most chromatic */
    --c2h-chromatic-extract-ds: oklch(from var(--c2h-color) l calc(c * 0.35) h);  /* most chromatic */

    /* from dark source colors (l < 0.5, not very chromatic) */
    --c2h-lightness-extract-ls: oklch(from var(--c2h-color) 0.99 calc(c * 0.2) h);  /* most light */
    --c2h-lightness-extract-ds: oklch(from var(--c2h-color) 0.08 calc(c * 0.1) h);  /* most light */

    /* */
    --c2h-lightness-inverse-ls: oklch(from var(--c2h-color) 0.01 calc(c * 0.2) h);  /* most dark */
    --c2h-lightness-inverse-ds: oklch(from var(--c2h-color) 0.99 calc(c * 0.1) h);  /* most dark (almost black) */

    /* */
    --c2h-lightness-extract: if(
        style(--c2h-theme-type: 1): var(--c2h-lightness-extract-ds);
        style(--c2h-theme-type: 0): var(--c2h-lightness-extract-ls);
        else: light-dark(var(--c2h-lightness-extract-ls), var(--c2h-lightness-extract-ds));
    );
    --c2h-chromatic-extract: if(
        style(--c2h-theme-type: 1): var(--c2h-chromatic-extract-ds);
        style(--c2h-theme-type: 0): var(--c2h-chromatic-extract-ls);
        else: light-dark(var(--c2h-chromatic-extract-ls), var(--c2h-chromatic-extract-ds));
    );
    --c2h-lightness-inverse: if(
        style(--c2h-theme-type: 1): var(--c2h-lightness-extract-ds);
        style(--c2h-theme-type: 0): var(--c2h-lightness-extract-ls);
        else: light-dark(var(--c2h-lightness-inverse-ls), var(--c2h-lightness-inverse-ds));
    );
    --c2h-chromatic-inverse: if(
        style(--c2h-theme-type: 1): var(--c2h-chromatic-inverse-ds);
        style(--c2h-theme-type: 0): var(--c2h-chromatic-inverse-ls);
        else: light-dark(var(--c2h-chromatic-inverse-ls), var(--c2h-chromatic-inverse-ds));
    );

    /* */
    result: --c2h-triple-mix(
        var(--c2h-lightness-extract),
        var(--c2h-chromatic-extract),
        var(--c2h-lightness-inverse),
        var(--c2h-factor, 0)
    );
}



/* */
@include make-func("@function --c2-surface(\
--c2-shift    <number>: 0, \
--c2-color     <color>: var(--current, var(--primary, currentColor)), \
--c2-theme    <number>: 2 \
)")
    { result: --c2h-re-shading(var(--c2-color, var(--primary, currentColor)), clamp(0, calc(0.02 + var(--c2-shift, 0) * 0.8), 1), var(--c2-theme, 2)); };

/* */
@include make-func("@function --c2-on-surface(\
--c2-shift      <number>: 0, \
--c2-color       <color>: var(--current, var(--primary, currentColor)), \
--c2-theme      <number>: 2 \
)")
    { result: --c2h-re-shading(var(--c2-color, var(--primary, currentColor)), clamp(0, calc(0.96 - var(--c2-shift, 0) * 0.8), 1), var(--c2-theme, 2)); };



/* */
@include make-func("@function --c2-contrast(\
--c2-shift    <number>: 0, \
--c2-color     <color>: var(--current, var(--primary, currentColor)), \
--c2-theme      <number>: 2 \
)")
    { result: --c2h-re-shading(var(--c2-color, var(--primary, currentColor)), clamp(0, calc(0.01 + var(--c2-shift, 0) * 0.6), 1), var(--c2-theme, 2)); };

/* */
@include make-func("@function --c2-on-contrast(\
--c2-shift      <number>: 0, \
--c2-color       <color>: var(--current, var(--primary, currentColor)), \
--c2-theme      <number>: 2 \
)")
    { result: --c2h-re-shading(var(--c2-color, var(--primary, currentColor)), clamp(0, calc(1 - var(--c2-shift, 0) * 0.6), 1), var(--c2-theme, 2)); };






//
@mixin make-md-theme($suffix: "", $theme-type: 2) {
    --md-c2-primary#{$suffix}: var(--current, var(--primary-fallback, #469));
    --md-c2-secondary#{$suffix}: var(--secondary, var(--secondary-fallback, var(--md-c2-primary#{$suffix})));
    --md-c2-tertiary#{$suffix}: var(--tertiary, var(--tertiary-fallback, var(--md-c2-secondary#{$suffix})));
    --md-c2-error#{$suffix}: var(--color-error, var(--color-danger, oklch(0.62 0.17 23 / 1)));
    --md-c2-neutral#{$suffix}: var(--surface-fallback, --c2-surface(0.2, var(--md-c2-primary#{$suffix}), #{$theme-type}));

    --md-c2-surface-shift#{$suffix}: clamp(0, calc(var(--background-tone-shift, 0.0) + 0.16), 1);
    --md-c2-on-surface-shift#{$suffix}: clamp(0, calc(var(--color-tone-shift, 0.0) + 0.06), 1);
    --md-c2-surface-variant-shift#{$suffix}: clamp(0, calc(var(--background-tone-shift, 0.0) + 0.34), 1);
    --md-c2-outline-shift#{$suffix}: clamp(0, calc(var(--color-tone-shift, 0.0) + 0.28), 1);
    --md-c2-contrast-shift#{$suffix}: clamp(0, calc(0.88 - var(--background-tone-shift, 0.0) * 0.3), 1);
    --md-c2-inverse-primary-shift#{$suffix}: clamp(0, calc(0.7 - var(--background-tone-shift, 0.0) * 0.2), 1);

    --md-sys-color-primary#{$suffix}: var(--md-c2-primary#{$suffix});
    --md-sys-color-on-primary#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-primary#{$suffix}), #{$theme-type});
    --md-sys-color-primary-container#{$suffix}: --c2-surface(0.74, var(--md-c2-primary#{$suffix}), #{$theme-type});
    --md-sys-color-on-primary-container#{$suffix}: --c2-on-surface(0.26, var(--md-c2-primary#{$suffix}), #{$theme-type});

    --md-sys-color-secondary#{$suffix}: var(--md-c2-secondary#{$suffix});
    --md-sys-color-on-secondary#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-secondary#{$suffix}), #{$theme-type});
    --md-sys-color-secondary-container#{$suffix}: --c2-surface(0.68, var(--md-c2-secondary#{$suffix}), #{$theme-type});
    --md-sys-color-on-secondary-container#{$suffix}: --c2-on-surface(0.24, var(--md-c2-secondary#{$suffix}), #{$theme-type});

    --md-sys-color-tertiary#{$suffix}: var(--md-c2-tertiary#{$suffix});
    --md-sys-color-on-tertiary#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-tertiary#{$suffix}), #{$theme-type});
    --md-sys-color-tertiary-container#{$suffix}: --c2-surface(0.64, var(--md-c2-tertiary#{$suffix}), #{$theme-type});
    --md-sys-color-on-tertiary-container#{$suffix}: --c2-on-surface(0.22, var(--md-c2-tertiary#{$suffix}), #{$theme-type});

    --md-sys-color-error#{$suffix}: var(--md-c2-error#{$suffix});
    --md-sys-color-on-error#{$suffix}: --c2-on-contrast(0.02, var(--md-c2-error#{$suffix}), #{$theme-type});
    --md-sys-color-error-container#{$suffix}: --c2-surface(0.72, var(--md-c2-error#{$suffix}), #{$theme-type});
    --md-sys-color-on-error-container#{$suffix}: --c2-on-surface(0.24, var(--md-c2-error#{$suffix}), #{$theme-type});

    --md-sys-color-surface#{$suffix}: --c2-surface(var(--md-c2-surface-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-on-surface#{$suffix}: --c2-on-surface(var(--md-c2-on-surface-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-surface-variant#{$suffix}: --c2-surface(var(--md-c2-surface-variant-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-on-surface-variant#{$suffix}: --c2-on-surface(clamp(0, calc(var(--md-c2-on-surface-shift#{$suffix}) + 0.14), 1), var(--md-c2-neutral#{$suffix}), #{$theme-type});

    --md-sys-color-outline#{$suffix}: color-mix(in oklch, --c2-on-surface(var(--md-c2-outline-shift), var(--md-c2-neutral#{$suffix}), #{$theme-type}) 58%, transparent);
    --md-sys-color-outline-variant#{$suffix}: color-mix(
        in oklch,
        --c2-on-surface(clamp(0, calc(var(--md-c2-outline-shift#{$suffix}) + 0.1), 1), var(--md-c2-neutral#{$suffix}), #{$theme-type}) 34%,
        --c2-surface(var(--md-c2-surface-variant-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type}) 66%
    );

    --md-sys-color-background#{$suffix}: --c2-surface(var(--background-tone-shift, 0.0), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-on-background#{$suffix}: --c2-on-surface(var(--color-tone-shift, 0.0), var(--md-c2-neutral#{$suffix}), #{$theme-type});

    --md-sys-color-inverse-surface#{$suffix}: --c2-contrast(var(--md-c2-contrast-shift#{$suffix}), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-inverse-on-surface#{$suffix}: --c2-on-contrast(clamp(0, calc(var(--md-c2-on-surface-shift#{$suffix}) + 0.06), 1), var(--md-c2-neutral#{$suffix}), #{$theme-type});
    --md-sys-color-inverse-primary#{$suffix}: --c2-contrast(var(--md-c2-inverse-primary-shift#{$suffix}), var(--md-c2-primary#{$suffix}), #{$theme-type});

    --md-sys-color-surface-tint#{$suffix}: var(--md-c2-primary#{$suffix});
    --md-sys-color-shadow#{$suffix}: color-mix(in oklch, var(--md-c2-neutral#{$suffix}) 24%, transparent);
    --md-sys-color-scrim#{$suffix}: color-mix(in oklch, var(--md-c2-neutral#{$suffix}) 70%, transparent);
}



//
@mixin material-color-c2-adapter-remap($selector: ":where(:root, :host, :scope, body, div, section)") {
    @layer md3.c2-adapter {
        #{$selector} {
            @include make-md-theme("", 2);
            @include make-md-theme("-dark", 1);
            @include make-md-theme("-light", 0);
        }
    }
}

//
@include material-color-c2-adapter-remap();

//
@layer ux-colors {
    /* Legacy */
    :root, :scope, :host {
        --primary-fallback: #469;
        --secondary-fallback: oklch(from var(--current) l calc(c * 0.88) calc(h + 120));
        --tertiary-fallback: oklch(from var(--current) l calc(c * 0.84) calc(h + 240));
        --accent-fallback: var(--tertiary-fallback);
        --surface-fallback: --c2-surface(0.2, var(--current));
        --surface-variant-fallback: --c2-surface(0.34, var(--current));
        --on-surface-fallback: --c2-on-surface(0.1, var(--current));
        --outline-fallback: color-mix(in oklch, --c2-on-surface(0.32, var(--current)) 56%, transparent);
        --outline-variant-fallback: color-mix(in oklch, --c2-on-surface(0.36, var(--current)) 32%, --c2-surface(0.32, var(--current)) 68%);
        --inverse-surface-fallback: --c2-contrast(0.86, var(--surface-fallback));
        --inverse-on-surface-fallback: --c2-on-contrast(0.08, var(--surface-fallback));
        --inverse-primary-fallback: --c2-contrast(0.72, var(--current));

        //
        --primary: var(--primary-fallback);
        --secondary: var(--secondary-fallback);
        --tertiary: var(--tertiary-fallback);
        --trinary: var(--tertiary);
        --accent: var(--accent-fallback);
        --current: var(--primary-fallback, #469);

        //
        @media(prefers-color-scheme: dark) { color-scheme: dark; }
        @media(prefers-color-scheme: light) { color-scheme: light; }

        //
        & { color-scheme: light; };
        &:is([data-scheme="dark"], [data-theme="dark"]) { color-scheme: dark only; }
        &:is([data-scheme="light"], [data-theme="light"]) { color-scheme: light only; }
        &:is([data-scheme="system"], [data-theme="system"]) { color-scheme: light dark; }
        &:is([data-scheme="auto"], [data-theme="auto"]) { color-scheme: light dark; }
    }

    //
    :host {
        --current: var(--primary, transparent);
        color-scheme: inherit;
    }

}
