/**
 * Font Loader Module
 *
 * Loads fonts from base64-encoded, compressed data using:
 * - Compression Streams API for decompression
 * - Blob URL for caching
 * - FontFace API (CSS Font Loading API) for font loading
 */
/**
 * Cache for Blob URLs to avoid re-creating them
 */
const blobUrlCache = new Map();
/**
 * Cache for FontFace instances
 */
const fontFaceCache = new Map();
/**
 * Decode base64 string to Uint8Array
 * Uses Uint8Array.fromBase64 if available, otherwise falls back to atob
 */
function decodeBase64(base64) {
    // Check if Uint8Array.fromBase64 is available (ES2024+)
    if (typeof Uint8Array.fromBase64 === 'function') {
        return Uint8Array.fromBase64(base64);
    }
    // Fallback: use atob for older browsers
    const binaryString = atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes;
}
/**
 * Decompress data using Compression Streams API
 * Only used for fonts that were compressed (e.g., gzip)
 * woff2 files are already compressed and don't need decompression
 */
async function decompress(data, algorithm = 'gzip') {
    // Check if CompressionStream is available
    if (typeof CompressionStream === 'undefined') {
        throw new Error('Compression Streams API is not supported in this browser');
    }
    // Use DecompressionStream for decompression
    const stream = new DecompressionStream(algorithm);
    const writer = stream.writable.getWriter();
    const reader = stream.readable.getReader();
    // Write compressed data
    writer.write(data);
    writer.close();
    // Read decompressed chunks
    const chunks = [];
    let done = false;
    while (!done) {
        const { value, done: readerDone } = await reader.read();
        done = readerDone;
        if (value) {
            chunks.push(value);
        }
    }
    // Combine chunks
    const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
    const result = new Uint8Array(totalLength);
    let offset = 0;
    for (const chunk of chunks) {
        result.set(chunk, offset);
        offset += chunk.length;
    }
    return result;
}
/**
 * Get or create a Blob URL from font data
 * Caches the URL to avoid re-creating Blobs
 */
async function getBlobUrl(fontData, cacheKey, mimeType = 'font/woff2') {
    // Check cache first
    if (blobUrlCache.has(cacheKey)) {
        return blobUrlCache.get(cacheKey);
    }
    // Create Blob and URL
    const blob = new Blob([fontData], { type: mimeType });
    const url = URL.createObjectURL(blob);
    // Cache the URL
    blobUrlCache.set(cacheKey, url);
    return url;
}
/**
 * Load a font from base64-encoded, compressed data
 */
export async function loadFont(metadata) {
    const { base64, family, style = 'normal', weight = 'normal', compressed = false } = metadata;
    // Create cache key
    const cacheKey = `${family}-${style}-${weight}`;
    // Check if FontFace is already cached
    if (fontFaceCache.has(cacheKey)) {
        return fontFaceCache.get(cacheKey);
    }
    // Decode base64 to Uint8Array
    const encodedData = decodeBase64(base64);
    // Decompress if needed (woff2 files are already compressed, don't decompress)
    // Only decompress if explicitly marked as compressed (e.g., gzip)
    const fontData = compressed ? await decompress(encodedData) : encodedData;
    // Determine MIME type based on compression
    // woff2 files are already compressed, so if not compressed, assume woff2
    const mimeType = compressed ? 'application/octet-stream' : 'font/woff2';
    // Get or create Blob URL
    const blobUrl = await getBlobUrl(fontData, cacheKey, mimeType);
    // Create FontFace instance
    const fontFace = new FontFace(family, `url(${blobUrl}) format('woff2')`, {
        style,
        weight: typeof weight === 'string' ? weight : `${weight}`,
        display: 'swap'
    });
    // Load the font
    await fontFace.load();
    // Add to document.fonts
    document.fonts.add(fontFace);
    // Cache the FontFace instance
    fontFaceCache.set(cacheKey, fontFace);
    return fontFace;
}
/**
 * Load multiple fonts
 */
export async function loadFonts(metadataArray) {
    const promises = metadataArray.map(metadata => loadFont(metadata));
    return Promise.all(promises);
}
let loadingFontRegistry = null;
export async function loadFontRegistry() {
    if (loadingFontRegistry) {
        return loadingFontRegistry;
    }
    loadingFontRegistry = import("./font-registry")?.catch?.((error) => { console.error("Failed to load font registry:", error); });
    ;
    return loadingFontRegistry;
}
/**
 * Load all fonts from the registry
 */
export async function loadAllFonts() {
    const fontRegistry = await loadFontRegistry();
    const metadataArray = Object.values(fontRegistry.fontRegistry);
    return loadFonts(metadataArray);
}
/**
 * Load fonts by family name
 */
export async function loadFontsByFamily(family) {
    const fontRegistry = await loadFontRegistry();
    const metadataArray = Object.values(fontRegistry.fontRegistry).filter(metadata => metadata.family === family);
    return loadFonts(metadataArray);
}
/**
 * Clear font caches (useful for testing or memory management)
 */
export function clearFontCache() {
    // Revoke all Blob URLs
    for (const url of blobUrlCache.values()) {
        URL.revokeObjectURL(url);
    }
    blobUrlCache.clear();
    fontFaceCache.clear();
}
/**
 * Font data registry (populated by Vite plugin)
 * Import from generated font-registry module
 */
//export { fontRegistry } from './font-registry';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9udC1sb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJmb250LWxvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HO0FBa0JIOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7QUFFL0M7O0dBRUc7QUFDSCxNQUFNLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztBQUVsRDs7O0dBR0c7QUFDSCxTQUFTLFlBQVksQ0FBQyxNQUFjO0lBQ2hDLHdEQUF3RDtJQUN4RCxJQUFJLE9BQU8sVUFBVSxDQUFDLFVBQVUsS0FBSyxVQUFVLEVBQUUsQ0FBQztRQUM5QyxPQUFPLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELHdDQUF3QztJQUN4QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDM0MsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsS0FBSyxVQUFVLFVBQVUsQ0FBQyxJQUFnQixFQUFFLFlBQStCLE1BQU07SUFDN0UsMENBQTBDO0lBQzFDLElBQUksT0FBTyxpQkFBaUIsS0FBSyxXQUFXLEVBQUUsQ0FBQztRQUMzQyxNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVELDRDQUE0QztJQUM1QyxNQUFNLE1BQU0sR0FB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R0FBRyxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3JCLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUMxQixDQUFDO0FBRUQ7OztHQUdHO0FBQ0gsaURBQWlEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBGb250IExvYWRlciBNb2R1bGVcbiAqXG4gKiBMb2FkcyBmb250cyBmcm9tIGJhc2U2NC1lbmNvZGVkLCBjb21wcmVzc2VkIGRhdGEgdXNpbmc6XG4gKiAtIENvbXByZXNzaW9uIFN0cmVhbXMgQVBJIGZvciBkZWNvbXByZXNzaW9uXG4gKiAtIEJsb2IgVVJMIGZvciBjYWNoaW5nXG4gKiAtIEZvbnRGYWNlIEFQSSAoQ1NTIEZvbnQgTG9hZGluZyBBUEkpIGZvciBmb250IGxvYWRpbmdcbiAqL1xuXG4vKipcbiAqIEZvbnQgbWV0YWRhdGEgZm9yIGxvYWRpbmdcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBGb250TWV0YWRhdGEge1xuICAgIC8qKiBCYXNlNjQtZW5jb2RlZCwgY29tcHJlc3NlZCBmb250IGRhdGEgKi9cbiAgICBiYXNlNjQ6IHN0cmluZztcbiAgICAvKiogRm9udCBmYW1pbHkgbmFtZSAqL1xuICAgIGZhbWlseTogc3RyaW5nO1xuICAgIC8qKiBGb250IHN0eWxlIChub3JtYWwsIGl0YWxpYywgZXRjLikgKi9cbiAgICBzdHlsZT86IHN0cmluZztcbiAgICAvKiogRm9udCB3ZWlnaHQgKDEwMC05MDAgb3IgXCIxMDAgOTAwXCIgZm9yIHZhcmlhYmxlIGZvbnRzKSAqL1xuICAgIHdlaWdodD86IHN0cmluZyB8IG51bWJlcjtcbiAgICAvKiogV2hldGhlciB0aGUgZm9udCBpcyBjb21wcmVzc2VkIChyZXF1aXJlcyBkZWNvbXByZXNzaW9uKSAqL1xuICAgIGNvbXByZXNzZWQ/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIENhY2hlIGZvciBCbG9iIFVSTHMgdG8gYXZvaWQgcmUtY3JlYXRpbmcgdGhlbVxuICovXG5jb25zdCBibG9iVXJsQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXG4vKipcbiAqIENhY2hlIGZvciBGb250RmFjZSBpbnN0YW5jZXNcbiAqL1xuY29uc3QgZm9udEZhY2VDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBGb250RmFjZT4oKTtcblxuLyoqXG4gKiBEZWNvZGUgYmFzZTY0IHN0cmluZyB0byBVaW50OEFycmF5XG4gKiBVc2VzIFVpbnQ4QXJyYXkuZnJvbUJhc2U2NCBpZiBhdmFpbGFibGUsIG90aGVyd2lzZSBmYWxscyBiYWNrIHRvIGF0b2JcbiAqL1xuZnVuY3Rpb24gZGVjb2RlQmFzZTY0KGJhc2U2NDogc3RyaW5nKTogVWludDhBcnJheSB7XG4gICAgLy8gQ2hlY2sgaWYgVWludDhBcnJheS5mcm9tQmFzZTY0IGlzIGF2YWlsYWJsZSAoRVMyMDI0KylcbiAgICBpZiAodHlwZW9mIFVpbnQ4QXJyYXkuZnJvbUJhc2U2NCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICByZXR1cm4gVWludDhBcnJheS5mcm9tQmFzZTY0KGJhc2U2NCk7XG4gICAgfVxuXG4gICAgLy8gRmFsbGJhY2s6IHVzZSBhdG9iIGZvciBvbGRlciBicm93c2Vyc1xuICAgIGNvbnN0IGJpbmFyeVN0cmluZyA9IGF0b2IoYmFzZTY0KTtcbiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGJpbmFyeVN0cmluZy5sZW5ndGgpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmluYXJ5U3RyaW5nLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGJ5dGVzW2ldID0gYmluYXJ5U3RyaW5nLmNoYXJDb2RlQXQoaSk7XG4gICAgfVxuICAgIHJldHVybiBieXRlcztcbn1cblxuLyoqXG4gKiBEZWNvbXByZXNzIGRhdGEgdXNpbmcgQ29tcHJlc3Npb24gU3RyZWFtcyBBUElcbiAqIE9ubHkgdXNlZCBmb3IgZm9udHMgdGhhdCB3ZXJlIGNvbXByZXNzZWQgKGUuZy4sIGd6aXApXG4gKiB3b2ZmMiBmaWxlcyBhcmUgYWxyZWFkeSBjb21wcmVzc2VkIGFuZCBkb24ndCBuZWVkIGRlY29tcHJlc3Npb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZGVjb21wcmVzcyhkYXRhOiBVaW50OEFycmF5LCBhbGdvcml0aG06IENvbXByZXNzaW9uRm9ybWF0ID0gJ2d6aXAnKTogUHJvbWlzZTxVaW50OEFycmF5PiB7XG4gICAgLy8gQ2hlY2sgaWYgQ29tcHJlc3Npb25TdHJlYW0gaXMgYXZhaWxhYmxlXG4gICAgaWYgKHR5cGVvZiBDb21wcmVzc2lvblN0cmVhbSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21wcmVzc2lvbiBTdHJlYW1zIEFQSSBpcyBub3Qgc3VwcG9ydGVkIGluIHRoaXMgYnJvd3NlcicpO1xuICAgIH1cblxuICAgIC8vIFVzZSBEZWNvbXByZXNzaW9uU3RyZWFtIGZvciBkZWNvbXByZXNzaW9uXG4gICAgY29uc3Qgc3RyZWFtID0gbmV3IERlY29tcHJlc3Npb25TdHJlYW0oYWxnb3JpdGhtKTtcbiAgICBjb25zdCB3cml0ZXIgPSBzdHJlYW0ud3JpdGFibGUuZ2V0V3JpdGVyKCk7XG4gICAgY29uc3QgcmVhZGVyID0gc3RyZWFtLnJlYWRhYmxlLmdldFJlYWRlcigpO1xuXG4gICAgLy8gV3JpdGUgY29tcHJlc3NlZCBkYXRhXG4gICAgd3JpdGVyLndyaXRlKGRhdGEpO1xuICAgIHdyaXRlci5jbG9zZSgpO1xuXG4gICAgLy8gUmVhZCBkZWNvbXByZXNzZWQgY2h1bmtzXG4gICAgY29uc3QgY2h1bmtzOiBVaW50OEFycmF5W10gPSBbXTtcbiAgICBsZXQgZG9uZSA9IGZhbHNlO1xuXG4gICAgd2hpbGUgKCFkb25lKSB7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIGRvbmU6IHJlYWRlckRvbmUgfSA9IGF3YWl0IHJlYWRlci5yZWFkKCk7XG4gICAgICAgIGRvbmUgPSByZWFkZXJEb25lO1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIGNodW5rcy5wdXNoKHZhbHVlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENvbWJpbmUgY2h1bmtzXG4gICAgY29uc3QgdG90YWxMZW5ndGggPSBjaHVua3MucmVkdWNlKChzdW0sIGNodW5rKSA9PiBzdW0gKyBjaHVuay5sZW5ndGgsIDApO1xuICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KHRvdGFsTGVuZ3RoKTtcbiAgICBsZXQgb2Zmc2V0ID0gMDtcbiAgICBmb3IgKGNvbnN0IGNodW5rIG9mIGNodW5rcykge1xuICAgICAgICByZXN1bHQuc2V0KGNodW5rLCBvZmZzZXQpO1xuICAgICAgICBvZmZzZXQgKz0gY2h1bmsubGVuZ3RoO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICogR2V0IG9yIGNyZWF0ZSBhIEJsb2IgVVJMIGZyb20gZm9udCBkYXRhXG4gKiBDYWNoZXMgdGhlIFVSTCB0byBhdm9pZCByZS1jcmVhdGluZyBCbG9ic1xuICovXG5hc3luYyBmdW5jdGlvbiBnZXRCbG9iVXJsKGZvbnREYXRhOiBVaW50OEFycmF5LCBjYWNoZUtleTogc3RyaW5nLCBtaW1lVHlwZTogc3RyaW5nID0gJ2ZvbnQvd29mZjInKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAvLyBDaGVjayBjYWNoZSBmaXJzdFxuICAgIGlmIChibG9iVXJsQ2FjaGUuaGFzKGNhY2hlS2V5KSkge1xuICAgICAgICByZXR1cm4gYmxvYlVybENhY2hlLmdldChjYWNoZUtleSkhO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBCbG9iIGFuZCBVUkxcbiAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2ZvbnREYXRhXSwgeyB0eXBlOiBtaW1lVHlwZSB9KTtcbiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuXG4gICAgLy8gQ2FjaGUgdGhlIFVSTFxuICAgIGJsb2JVcmxDYWNoZS5zZXQoY2FjaGVLZXksIHVybCk7XG5cbiAgICByZXR1cm4gdXJsO1xufVxuXG4vKipcbiAqIExvYWQgYSBmb250IGZyb20gYmFzZTY0LWVuY29kZWQsIGNvbXByZXNzZWQgZGF0YVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZEZvbnQobWV0YWRhdGE6IEZvbnRNZXRhZGF0YSk6IFByb21pc2U8Rm9udEZhY2U+IHtcbiAgICBjb25zdCB7IGJhc2U2NCwgZmFtaWx5LCBzdHlsZSA9ICdub3JtYWwnLCB3ZWlnaHQgPSAnbm9ybWFsJywgY29tcHJlc3NlZCA9IGZhbHNlIH0gPSBtZXRhZGF0YTtcblxuICAgIC8vIENyZWF0ZSBjYWNoZSBrZXlcbiAgICBjb25zdCBjYWNoZUtleSA9IGAke2ZhbWlseX0tJHtzdHlsZX0tJHt3ZWlnaHR9YDtcblxuICAgIC8vIENoZWNrIGlmIEZvbnRGYWNlIGlzIGFscmVhZHkgY2FjaGVkXG4gICAgaWYgKGZvbnRGYWNlQ2FjaGUuaGFzKGNhY2hlS2V5KSkge1xuICAgICAgICByZXR1cm4gZm9udEZhY2VDYWNoZS5nZXQoY2FjaGVLZXkpITtcbiAgICB9XG5cbiAgICAvLyBEZWNvZGUgYmFzZTY0IHRvIFVpbnQ4QXJyYXlcbiAgICBjb25zdCBlbmNvZGVkRGF0YSA9IGRlY29kZUJhc2U2NChiYXNlNjQpO1xuXG4gICAgLy8gRGVjb21wcmVzcyBpZiBuZWVkZWQgKHdvZmYyIGZpbGVzIGFyZSBhbHJlYWR5IGNvbXByZXNzZWQsIGRvbid0IGRlY29tcHJlc3MpXG4gICAgLy8gT25seSBkZWNvbXByZXNzIGlmIGV4cGxpY2l0bHkgbWFya2VkIGFzIGNvbXByZXNzZWQgKGUuZy4sIGd6aXApXG4gICAgY29uc3QgZm9udERhdGEgPSBjb21wcmVzc2VkID8gYXdhaXQgZGVjb21wcmVzcyhlbmNvZGVkRGF0YSkgOiBlbmNvZGVkRGF0YTtcblxuICAgIC8vIERldGVybWluZSBNSU1FIHR5cGUgYmFzZWQgb24gY29tcHJlc3Npb25cbiAgICAvLyB3b2ZmMiBmaWxlcyBhcmUgYWxyZWFkeSBjb21wcmVzc2VkLCBzbyBpZiBub3QgY29tcHJlc3NlZCwgYXNzdW1lIHdvZmYyXG4gICAgY29uc3QgbWltZVR5cGUgPSBjb21wcmVzc2VkID8gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScgOiAnZm9udC93b2ZmMic7XG5cbiAgICAvLyBHZXQgb3IgY3JlYXRlIEJsb2IgVVJMXG4gICAgY29uc3QgYmxvYlVybCA9IGF3YWl0IGdldEJsb2JVcmwoZm9udERhdGEsIGNhY2hlS2V5LCBtaW1lVHlwZSk7XG5cbiAgICAvLyBDcmVhdGUgRm9udEZhY2UgaW5zdGFuY2VcbiAgICBjb25zdCBmb250RmFjZSA9IG5ldyBGb250RmFjZShcbiAgICAgICAgZmFtaWx5LFxuICAgICAgICBgdXJsKCR7YmxvYlVybH0pIGZvcm1hdCgnd29mZjInKWAsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHN0eWxlLFxuICAgICAgICAgICAgd2VpZ2h0OiB0eXBlb2Ygd2VpZ2h0ID09PSAnc3RyaW5nJyA/IHdlaWdodCA6IGAke3dlaWdodH1gLFxuICAgICAgICAgICAgZGlzcGxheTogJ3N3YXAnXG4gICAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gTG9hZCB0aGUgZm9udFxuICAgIGF3YWl0IGZvbnRGYWNlLmxvYWQoKTtcblxuICAgIC8vIEFkZCB0byBkb2N1bWVudC5mb250c1xuICAgIGRvY3VtZW50LmZvbnRzLmFkZChmb250RmFjZSk7XG5cbiAgICAvLyBDYWNoZSB0aGUgRm9udEZhY2UgaW5zdGFuY2VcbiAgICBmb250RmFjZUNhY2hlLnNldChjYWNoZUtleSwgZm9udEZhY2UpO1xuXG4gICAgcmV0dXJuIGZvbnRGYWNlO1xufVxuXG4vKipcbiAqIExvYWQgbXVsdGlwbGUgZm9udHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRGb250cyhtZXRhZGF0YUFycmF5OiBGb250TWV0YWRhdGFbXSk6IFByb21pc2U8Rm9udEZhY2VbXT4ge1xuICAgIGNvbnN0IHByb21pc2VzID0gbWV0YWRhdGFBcnJheS5tYXAobWV0YWRhdGEgPT4gbG9hZEZvbnQobWV0YWRhdGEpKTtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuXG5sZXQgbG9hZGluZ0ZvbnRSZWdpc3RyeTogYW55ID0gbnVsbDtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkRm9udFJlZ2lzdHJ5KCk6IFByb21pc2U8YW55PiB7XG4gICAgaWYgKGxvYWRpbmdGb250UmVnaXN0cnkpIHtcbiAgICAgICAgcmV0dXJuIGxvYWRpbmdGb250UmVnaXN0cnk7XG4gICAgfVxuICAgIGxvYWRpbmdGb250UmVnaXN0cnkgPSBpbXBvcnQoXCIuL2ZvbnQtcmVnaXN0cnlcIik/LmNhdGNoPy4oKGVycm9yOiBhbnkpID0+IHsgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBsb2FkIGZvbnQgcmVnaXN0cnk6XCIsIGVycm9yKTsgfSk7O1xuICAgIHJldHVybiBsb2FkaW5nRm9udFJlZ2lzdHJ5O1xufVxuXG4vKipcbiAqIExvYWQgYWxsIGZvbnRzIGZyb20gdGhlIHJlZ2lzdHJ5XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkQWxsRm9udHMoKTogUHJvbWlzZTxGb250RmFjZVtdPiB7XG4gICAgY29uc3QgZm9udFJlZ2lzdHJ5ID0gYXdhaXQgbG9hZEZvbnRSZWdpc3RyeSgpO1xuICAgIGNvbnN0IG1ldGFkYXRhQXJyYXkgPSBPYmplY3QudmFsdWVzKGZvbnRSZWdpc3RyeS5mb250UmVnaXN0cnkgYXMgUmVjb3JkPHN0cmluZywgRm9udE1ldGFkYXRhPik7XG4gICAgcmV0dXJuIGxvYWRGb250cyhtZXRhZGF0YUFycmF5KTtcbn1cblxuLyoqXG4gKiBMb2FkIGZvbnRzIGJ5IGZhbWlseSBuYW1lXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkRm9udHNCeUZhbWlseShmYW1pbHk6IHN0cmluZyk6IFByb21pc2U8Rm9udEZhY2VbXT4ge1xuICAgIGNvbnN0IGZvbnRSZWdpc3RyeSA9IGF3YWl0IGxvYWRGb250UmVnaXN0cnkoKTtcbiAgICBjb25zdCBtZXRhZGF0YUFycmF5ID0gT2JqZWN0LnZhbHVlcyhmb250UmVnaXN0cnkuZm9udFJlZ2lzdHJ5IGFzIFJlY29yZDxzdHJpbmcsIEZvbnRNZXRhZGF0YT4pLmZpbHRlcihcbiAgICAgICAgbWV0YWRhdGEgPT4gbWV0YWRhdGEuZmFtaWx5ID09PSBmYW1pbHlcbiAgICApO1xuICAgIHJldHVybiBsb2FkRm9udHMobWV0YWRhdGFBcnJheSk7XG59XG5cbi8qKlxuICogQ2xlYXIgZm9udCBjYWNoZXMgKHVzZWZ1bCBmb3IgdGVzdGluZyBvciBtZW1vcnkgbWFuYWdlbWVudClcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNsZWFyRm9udENhY2hlKCk6IHZvaWQge1xuICAgIC8vIFJldm9rZSBhbGwgQmxvYiBVUkxzXG4gICAgZm9yIChjb25zdCB1cmwgb2YgYmxvYlVybENhY2hlLnZhbHVlcygpKSB7XG4gICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTtcbiAgICB9XG5cbiAgICBibG9iVXJsQ2FjaGUuY2xlYXIoKTtcbiAgICBmb250RmFjZUNhY2hlLmNsZWFyKCk7XG59XG5cbi8qKlxuICogRm9udCBkYXRhIHJlZ2lzdHJ5IChwb3B1bGF0ZWQgYnkgVml0ZSBwbHVnaW4pXG4gKiBJbXBvcnQgZnJvbSBnZW5lcmF0ZWQgZm9udC1yZWdpc3RyeSBtb2R1bGVcbiAqL1xuLy9leHBvcnQgeyBmb250UmVnaXN0cnkgfSBmcm9tICcuL2ZvbnQtcmVnaXN0cnknO1xuIl19